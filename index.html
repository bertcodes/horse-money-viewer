<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">股票行情查看器 - Leeks</title>
    <meta name="description" content="简洁实用的股票行情查看工具，支持A股、港股、美股实时行情，成本价管理，目标价止损设置">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .refresh-info {
            color: #7f8c8d;
            font-size: 12px;
            margin-left: 15px;
        }

        .stock-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stock-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .stock-input input:focus {
            outline: none;
            border-color: #3498db;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: #219a52;
        }

        .help-text {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 8px;
        }

        .stock-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .stock-list {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stock-table th {
            background: #34495e;
            color: white;
            padding: 10px 10px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        .stock-table th:hover {
            background: #2c3e50;
        }

        .stock-table th::after {
            content: '↕';
            margin-left: 3px;
            opacity: 0.3;
        }

        .stock-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .stock-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .stock-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            white-space: nowrap;
        }

        .stock-table tr:hover {
            background: #f8f9fa;
        }

        .stock-table tr:hover td {
            cursor: pointer;
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .container {
                margin: 5px auto;
                padding: 0 5px;
            }

            .header {
                flex-direction: row;
                gap: 5px;
                padding: 8px 10px;
            }

            .header h1 {
                font-size: 16px;
            }

            .refresh-btn {
                padding: 5px 12px;
                font-size: 12px;
            }

            .refresh-info {
                display: none;
            }

            .stock-input {
                flex-direction: row;
                padding: 8px 10px;
                gap: 5px;
            }

            .stock-input input {
                flex: 1;
                font-size: 12px;
                padding: 6px 8px;
            }

            .add-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .toolbar {
                flex-direction: column;
                gap: 5px;
                padding: 8px 10px;
            }

            .toolbar-left,
            .toolbar-right {
                flex-wrap: wrap;
                justify-content: flex-start;
                align-items: center;
                gap: 5px;
            }

            .toolbar-btn {
                padding: 4px 10px;
                font-size: 11px;
                white-space: nowrap;
            }

            #searchInput {
                width: 140px !important;
                font-size: 12px !important;
                padding: 4px 8px !important;
            }

            #filterSelect {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }

            .toolbar-right span {
                font-size: 10px !important;
            }

            #refreshIntervalInput {
                width: 40px !important;
                font-size: 11px !important;
                padding: 2px 4px !important;
            }

            .stock-table th {
                padding: 5px 4px;
                font-size: 9px;
            }

            .stock-table td {
                padding: 4px 3px;
                font-size: 10px;
            }

            .price-status {
                min-width: 50px;
                font-size: 9px;
                padding: 1px 4px;
            }

            .chart-container {
                max-width: 95vw;
                margin: 10px;
            }

            .chart-content img {
                max-height: 40vh;
            }

            .shortcut-hint {
                display: none;
            }
        }

        /* 超小屏幕 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 14px;
            }

            .header {
                padding: 5px 8px;
            }

            .refresh-btn,
            .add-btn,
            .toolbar-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .stock-table th,
            .stock-table td {
                padding: 4px 2px;
                font-size: 9px;
            }

            #searchInput {
                width: 100px !important;
            }
        }

        /* 列设置弹窗 */
        .column-settings-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .column-settings-popup.active {
            display: flex;
        }

        .column-settings-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .column-settings-content {
            overflow-y: auto;
            max-height: 60vh;
            padding: 10px 0;
        }

        .column-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .column-checkbox-item:last-child {
            border-bottom: none;
        }

        .column-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }

        .column-checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .column-settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .column-settings-buttons .toolbar-btn {
            flex: 1;
        }

        /* 涨跌颜色 */
        .red {
            color: #e74c3c;
        }

        .green {
            color: #27ae60;
        }

        .gray {
            color: #95a5a6;
        }

        /* 隐蔽模式 */
        body.stealth-mode {
            background: #fafafa;
        }

        body.stealth-mode .header h1 {
            color: #bdc3c7;
        }

        body.stealth-mode .header,
        body.stealth-mode .stock-input,
        body.stealth-mode .toolbar {
            background: #f5f5f5;
            box-shadow: none;
            border: 1px solid #e0e0e0;
        }

        body.stealth-mode .stock-table {
            background: #fafafa;
        }

        body.stealth-mode .stock-table th {
            background: #ecf0f1;
            color: #95a5a6;
        }

        body.stealth-mode .stock-table tr:hover {
            background: transparent;
        }

        body.stealth-mode .stock-table td {
            color: #7f8c8d;
        }

        body.stealth-mode .red,
        body.stealth-mode .green {
            color: #7f8c8d !important;
        }

        body.stealth-mode .refresh-btn {
            background: #95a5a6;
        }

        body.stealth-mode .refresh-btn:hover {
            background: #7f8c8d;
        }

        body.stealth-mode .add-btn {
            background: #95a5a6;
        }

        body.stealth-mode .add-btn:hover {
            background: #7f8c8d;
        }

        body.stealth-mode .auto-refresh-indicator {
            background: #95a5a6;
            animation: none;
        }

        body.stealth-mode .refresh-info {
            color: #bdc3c7;
        }

        body.stealth-mode .toolbar-btn {
            border-color: #e0e0e0;
            color: #95a5a6;
        }

        body.stealth-mode .toolbar-btn:hover {
            background: #ecf0f1;
        }

        body.stealth-mode .delete-btn {
            color: #95a5a6 !important;
            border-color: #e0e0e0 !important;
        }

        body.stealth-mode .delete-btn:hover {
            background: #ecf0f1 !important;
            color: #95a5a6 !important;
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: #f5f5f5;
        }

        .toolbar-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .delete-btn {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* 图表弹窗 */
        .chart-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chart-popup.active {
            display: flex;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .chart-container.edit-container {
            max-width: 400px;
            max-height: 85vh;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        /* 编辑表单 */
        .edit-form {
            padding: 10px 0;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #34495e;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group input[readonly] {
            background: #f5f5f5;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .form-buttons .toolbar-btn {
            flex: 1;
            text-align: center;
            padding: 6px 12px;
            font-size: 13px;
        }

        /* 可编辑单元格 */
        .editable {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s;
        }

        .editable:hover {
            color: #2980b9;
            text-decoration: none;
        }

        body.stealth-mode .editable {
            color: #7f8c8d;
        }

        body.stealth-mode .editable:hover {
            color: #95a5a6;
        }

        .chart-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .chart-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .chart-tab:hover {
            background: #f5f5f5;
        }

        .chart-tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 500;
        }

        .chart-content {
            display: none;
        }

        .chart-content.active {
            display: block;
        }

        .chart-content img {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .chart-error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        /* 右键菜单 */
        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            z-index: 1001;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #3498db;
            color: white;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* 价格状态标签 */
        .price-status {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .price-status.target {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .price-status.stop {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .price-status.neutral {
            background: transparent;
            color: #7f8c8d;
        }

        /* 悬停提示 */
        .price-tooltip {
            position: relative;
            cursor: help;
        }

        .price-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            margin-bottom: 8px;
            pointer-events: none;
        }

        .price-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .price-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            margin-bottom: -4px;
            pointer-events: none;
        }

        .price-tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* 快捷键提示 */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #7f8c8d;
            border: 1px solid #3498db;
        }

        body.stealth-mode .shortcut-hint {
            display: none;
        }

        .shortcut-hint kbd {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ddd;
            font-family: monospace;
            margin: 0 2px;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        /* 自动刷新指示器 */
        .auto-refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .auto-refresh-indicator.paused {
            background: #e74c3c;
            animation: none;
        }

        /* 搜索建议下拉框 */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 2px;
        }

        .suggestions-dropdown.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .suggestion-item:hover {
            background: #e8f4fd;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:active {
            background: #d4edf9;
        }

        .suggestion-code {
            font-weight: 600;
            color: #3498db;
            font-size: 13px;
            min-width: 80px;
        }

        .suggestion-name {
            color: #333;
            font-size: 14px;
            flex: 1;
        }

        .suggestion-loading {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 13px;
        }

        .suggestion-no-result {
            padding: 20px;
            text-align: center;
            color: #95a5a6;
            font-size: 13px;
        }

        /* 移动端优化下拉框 */
        @media (max-width: 768px) {
            .suggestions-dropdown {
                max-height: 250px;
            }

            .suggestion-item {
                padding: 10px 12px;
            }

            .suggestion-code {
                font-size: 12px;
                min-width: 70px;
            }

            .suggestion-name {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>马钱行情</h1>
            <div>
                <button class="refresh-btn" onclick="refreshStocks()">
                    <span class="auto-refresh-indicator" id="autoRefreshIndicator"></span>
                    刷新数据
                </button>
                <span class="refresh-info" id="refreshInfo">最后刷新: --</span>
            </div>
        </div>

        <div class="stock-input">
            <div style="flex: 1; position: relative;">
                <input type="text" id="stockInput" placeholder="输入股票代码或名称，如: sh600519、贵州茅台"
                       onkeypress="if(event.key==='Enter') addStock()" oninput="handleStockInput(event)"
                       autocomplete="off">
                <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
            </div>
            <button class="add-btn" onclick="addStock()">添加</button>
            <div style="flex: 1"></div>
            <button class="toolbar-btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">刷新: 开</button>
            <button class="toolbar-btn" onclick="toggleStealthMode()" id="stealthModeBtn">隐蔽</button>
        </div>

        <div class="toolbar">
            <div class="toolbar-left">
                <button class="toolbar-btn" onclick="clearAllStocks()" style="color: #e74c3c;">清空</button>
                <button class="toolbar-btn" onclick="openCloudSync()">云端同步</button>
                <button class="toolbar-btn" onclick="openColumnSettings()">列设置</button>
                <button class="toolbar-btn" onclick="openVoiceSettings()">语音播报</button>
            </div>
            <div class="toolbar-right">
                <span id="totalMarketValue" style="font-size: 12px; color: #7f8c8d; margin-right: 15px;">总市值: --</span>
                <span id="totalIncome" style="font-size: 12px; color: #7f8c8d; margin-right: 15px;">总收益: --</span>
                <span style="font-size: 12px; color: #7f8c8d; margin-right: 5px;">刷新:</span>
                <input type="number" id="refreshIntervalInput" min="3" max="300" step="1" value="10"
                       onchange="changeRefreshInterval(this.value)"
                       style="width: 50px; padding: 2px 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; margin-right: 3px;">
                <span style="font-size: 12px; color: #7f8c8d;">秒</span>
            </div>
        </div>

        <div class="toolbar">
            <div class="toolbar-left">
                <input type="text" id="searchInput" placeholder="搜索股票名称或代码..." oninput="filterStocks()"
                       style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 200px;">
                <span style="font-size: 12px; color: #7f8c8d; margin-left: 10px;">快速筛选: </span>
                <select id="filterSelect" onchange="filterByStatus(this.value)"
                        style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; cursor: pointer;">
                    <option value="all">全部</option>
                    <option value="profit">盈利</option>
                    <option value="loss">亏损</option>
                    <option value="target">已达目标</option>
                </select>
            </div>
        </div>

        <div class="stock-list">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('code')">编码</th>
                        <th onclick="sortTable('name')">股票名称</th>
                        <th onclick="sortTable('now')">当前价</th>
                        <th onclick="sortTable('change')">涨跌</th>
                        <th onclick="sortTable('changePercent')">涨跌幅</th>
                        <th onclick="sortTable('volume')">成交量</th>
                        <th onclick="sortTable('amount')">成交额</th>
                        <th onclick="sortTable('time')">更新时间</th>
                        <th onclick="sortTable('max')">最高价</th>
                        <th onclick="sortTable('min')">最低价</th>
                        <th>成本价</th>
                        <th>持仓</th>
                        <th onclick="sortTable('marketValue')">持仓市值</th>
                        <th>收益率</th>
                        <th>收益</th>
                        <th onclick="sortTable('targetPrice')">目标价</th>
                        <th onclick="sortTable('stopLoss')">止损价</th>
                        <th>预测趋势</th>
                        <th>状态</th>
                        <th onclick="sortTable('yieldToTarget')">目标收益</th>
                        <th onclick="sortTable('yieldToStop')">止损损失</th>
                        <th onclick="sortTable('riskRewardRatio')">盈亏比</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    <!-- 股票数据将在这里动态插入 -->
                </tbody>
            </table>
        </div>

        <!-- 编辑弹窗 -->
        <div class="chart-popup" id="editPopup" onclick="closeEditPopup(event)">
            <div class="chart-container" onclick="event.stopPropagation()">
                <div class="chart-header">
                    <span class="chart-title" id="editTitle">编辑股票</span>
                    <button class="close-btn" onclick="closeEditPopup()">×</button>
                </div>
                <div class="edit-form">
                    <div class="form-group">
                        <label>股票代码</label>
                        <input type="text" id="editCode" readonly>
                    </div>
                    <div class="form-group">
                        <label>股票名称</label>
                        <input type="text" id="editName" readonly>
                    </div>
                    <div class="form-group">
                        <label>成本价</label>
                        <input type="number" id="editCost" placeholder="输入成本价，如: 1000">
                    </div>
                    <div class="form-group">
                        <label>持仓数量</label>
                        <input type="number" id="editBonds" placeholder="输入持仓数量，如: 100">
                    </div>
                    <div class="form-group">
                        <label>目标价</label>
                        <input type="number" id="editTargetPrice" placeholder="输入目标价，如: 1200" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>止损价</label>
                        <input type="number" id="editStopLoss" placeholder="输入止损价，如: 900" step="0.01">
                    </div>
                    <div class="form-buttons">
                        <button class="toolbar-btn" onclick="closeEditPopup()">取消</button>
                        <button class="toolbar-btn active" onclick="saveEdit()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快捷键提示 -->
        <div class="shortcut-hint" id="shortcutHint">
            <div><kbd>Ctrl</kbd> + <kbd>H</kbd> 快速切换隐蔽模式</div>
            <div style="margin-top: 5px;"><kbd>Ctrl</kbd> + <kbd>R</kbd> 刷新数据</div>
            <div style="margin-top: 5px;"><kbd>ESC</kbd> 关闭弹窗</div>
        </div>
    </div>

    <!-- 图表弹窗 -->
    <div class="chart-popup" id="chartPopup" onclick="closeChart(event)">
        <div class="chart-container" onclick="event.stopPropagation()">
            <div class="chart-header">
                <span class="chart-title" id="chartTitle">股票图表</span>
                <button class="close-btn" onclick="closeChart()">×</button>
            </div>
            <div class="chart-tabs">
                <div class="chart-tab active" data-type="min">分时图</div>
                <div class="chart-tab" data-type="daily">日K线</div>
                <div class="chart-tab" data-type="weekly">周K线</div>
                <div class="chart-tab" data-type="monthly">月K线</div>
            </div>
            <div class="chart-content active" id="chartContent">
                <img id="chartImage" src="" alt="股票图表">
            </div>
        </div>
    </div>

        <!-- 右键菜单 -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" data-type="min">分时图</div>
            <div class="context-menu-item" data-type="daily">日K线</div>
            <div class="context-menu-item" data-type="weekly">周K线</div>
            <div class="context-menu-item" data-type="monthly">月K线</div>
        </div>

        <!-- 列设置弹窗 -->
        <div class="column-settings-popup" id="columnSettingsPopup" onclick="closeColumnSettings(event)">
            <div class="column-settings-container" onclick="event.stopPropagation()">
                <div class="chart-header">
                    <span class="chart-title">列显示设置</span>
                    <button class="close-btn" onclick="closeColumnSettings()">×</button>
                </div>
                <div class="column-settings-content" id="columnSettingsContent">
                    <!-- 列选项将在这里动态生成 -->
                </div>
                <div class="column-settings-buttons">
                    <button class="toolbar-btn" onclick="selectAllColumns()">全选</button>
                    <button class="toolbar-btn" onclick="deselectAllColumns()">全不选</button>
                    <button class="toolbar-btn active" onclick="saveColumnSettings()">确定</button>
                </div>
            </div>
        </div>

        <!-- 云端同步弹窗 -->
        <div class="column-settings-popup" id="cloudSyncPopup" onclick="closeCloudSync(event)">
            <div class="column-settings-container" onclick="event.stopPropagation()" style="max-width: 500px;">
                <div class="chart-header">
                    <span class="chart-title">云端同步设置</span>
                    <button class="close-btn" onclick="closeCloudSync()">×</button>
                </div>
                <div class="column-settings-content" style="padding: 20px;">
                    <!-- 未配置状态 -->
                    <div id="notConfigured" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">配置 GitHub Token</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                1. 点击下方按钮前往 GitHub 生成 Personal Access Token<br>
                                2. 勾选 <code>gist</code> 权限<br>
                                3. 复制 Token 并粘贴到下方输入框
                            </p>
                            <a href="https://github.com/settings/tokens/new?scopes=gist&description=Leeks%20Stock%20Viewer" target="_blank" style="display: block; margin-bottom: 15px;">
                                <button class="toolbar-btn">获取 GitHub Token</button>
                            </a>
                            <input type="password" id="githubTokenInput" placeholder="粘贴 GitHub Token" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                            <button class="toolbar-btn active" onclick="saveGitHubToken()" style="width: 100%;">保存 Token</button>
                        </div>
                    </div>

                    <!-- 已配置状态 -->
                    <div id="configured" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">同步设置</h4>
                            <label style="display: block; margin-bottom: 15px;">
                                <input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync()">
                                自动同步（数据变化时自动备份）
                            </label>
                            <div id="lastSyncTime" style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                上次同步: --
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">GitHub Token</h4>
                            <div style="display: flex; gap: 10px; align-items: stretch;">
                                <input type="text" id="githubTokenDisplay" readonly placeholder="GitHub Token"
                                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5; font-family: monospace; font-size: 11px;">
                                <button class="toolbar-btn" onclick="copyGitHubToken()" id="copyTokenBtn" style="min-width: 80px;">复制</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="toolbar-btn active" onclick="backupToGitHub(this)" style="flex: 1;">立即备份</button>
                            <button class="toolbar-btn" onclick="restoreFromGitHub(this)" style="flex: 1;">恢复数据</button>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Gist 信息</h4>
                            <div id="gistInfo" style="font-size: 12px; color: #666;"></div>
                            <div style="margin-top: 10px;">
                                <label style="font-size: 12px; color: #666;">手动设置 Gist ID（多设备同步时使用）:</label>
                                <input type="text" id="manualGistId" placeholder="输入 Gist ID，如: 6efbf674..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                                <button class="toolbar-btn" onclick="setManualGistId()" style="width: 100%; margin-top: 5px;">设置 Gist ID</button>
                            </div>
                        </div>

                        <button class="toolbar-btn" onclick="clearGitHubToken()" style="color: #e74c3c; width: 100%;">清除配置</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 语音播报设置弹窗 -->
        <div class="column-settings-popup" id="voiceSettingsPopup" onclick="closeVoiceSettings(event)">
            <div class="column-settings-container" onclick="event.stopPropagation()">
                <div class="chart-header">
                    <span class="chart-title">语音播报设置</span>
                    <button class="close-btn" onclick="closeVoiceSettings()">×</button>
                </div>
                <div class="column-settings-content" style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 15px; font-size: 14px;">
                            <input type="checkbox" id="voiceEnabledCheckbox" onchange="toggleVoiceBroadcast()">
                            开启语音播报
                        </label>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">播报间隔（秒）:</label>
                            <input type="number" id="voiceIntervalInput" min="1" max="300" step="1" value="3"
                                   onchange="changeVoiceInterval(this.value)"
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">选择要播报的股票</h4>
                        <div id="voiceStockList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                            <!-- 股票列表将在这里动态生成 -->
                        </div>
                    </div>

                    <button class="toolbar-btn active" onclick="testVoiceBroadcast()" style="width: 100%; margin-top: 10px;">测试播报</button>
                </div>
            </div>
        </div>

    <script>
        // 股票数据存储
        let stocks = JSON.parse(localStorage.getItem('leeks_stocks') || '[]');
        let autoRefreshEnabled = localStorage.getItem('leeks_auto_refresh') !== 'false';
        let stealthMode = localStorage.getItem('leeks_stealth_mode') === 'true';
        let sortColumn = localStorage.getItem('leeks_sort_column') || 'code';
        let sortDirection = localStorage.getItem('leeks_sort_direction') || 'asc';
        let refreshTimer = null;
        let currentChartStock = null;
        let currentFilter = 'all';
        let searchText = '';
        let refreshInterval = parseInt(localStorage.getItem('leeks_refresh_interval')) || 10; // 默认10秒
        let searchTimeout = null;

        // 语音播报相关
        let voiceBroadcastEnabled = localStorage.getItem('leeks_voice_broadcast') === 'true';
        let voiceBroadcastStocks = JSON.parse(localStorage.getItem('leeks_voice_stocks') || '[]'); // 选中的股票列表
        let voiceBroadcastInterval = parseInt(localStorage.getItem('leeks_voice_interval')) || 3; // 播报间隔（秒）
        let voiceBroadcastTimer = null;

        // 本地股票数据库（备用方案）
        const localStockDatabase = [
            // A股 - 热门股票
            { code: 'sh600519', name: '贵州茅台', pinyin: 'gzmt' },
            { code: 'sh601318', name: '中国平安', pinyin: 'zgpa' },
            { code: 'sh600036', name: '招商银行', pinyin: 'zsya' },
            { code: 'sh000858', name: '五粮液', pinyin: 'wly' },
            { code: 'sz000001', name: '平安银行', pinyin: 'payx' },
            { code: 'sz000002', name: '万科A', pinyin: 'wka' },
            { code: 'sz000063', name: '中兴通讯', pinyin: 'zxtx' },
            { code: 'sz000333', name: '美的集团', pinyin: 'mdjt' },
            { code: 'sz000651', name: '格力电器', pinyin: 'gldq' },
            { code: 'sz000858', name: '五粮液', pinyin: 'wly' },
            { code: 'sz002594', name: '比亚迪', pinyin: 'byd' },
            { code: 'sz300750', name: '宁德时代', pinyin: 'ndsd' },
            { code: 'sz300059', name: '东方财富', pinyin: 'dfcf' },
            { code: 'sz002415', name: '海康威视', pinyin: 'hkws' },
            { code: 'sz000568', name: '泸州老窖', pinyin: 'lzlj' },
            { code: 'sz300274', name: '阳光电源', pinyin: 'ygdy' },
            { code: 'sz002594', name: '比亚迪', pinyin: 'byd' },
            { code: 'sz300015', name: '爱尔眼科', pinyin: 'aeyk' },
            { code: 'sz002304', name: '洋河股份', pinyin: 'yhg' },
            { code: 'sz002271', name: '东方雨虹', pinyin: 'dfyh' },
            { code: 'sh600900', name: '长江电力', pinyin: 'cjdl' },
            { code: 'sh600887', name: '伊利股份', pinyin: 'ylyg' },
            { code: 'sh601888', name: '中国中免', pinyin: 'zgzmb' },
            { code: 'sh600276', name: '恒瑞医药', pinyin: 'hrjy' },
            { code: 'sh603259', name: '药明康德', pinyin: 'ymkd' },
            { code: 'sz000997', name: '新大陆', pinyin: 'xdl' },
            { code: 'sz002995', name: '天地在线', pinyin: 'tdzx' },
            { code: 'sz000568', name: '泸州老窖', pinyin: 'lzlj' },

            // 港股 - 热门股票
            { code: 'hk00700', name: '腾讯控股', pinyin: 'txkg' },
            { code: 'hk09988', name: '阿里巴巴', pinyin: 'albb' },
            { code: 'hk03690', name: '美团', pinyin: 'meituan' },
            { code: 'hk01810', name: '小米集团', pinyin: 'xmjt' },
            { code: 'hk00941', name: '中国移动', pinyin: 'zgyd' },
            { code: 'hk01299', name: '友邦保险', pinyin: 'yabx' },
            { code: 'hk02318', name: '中国平安', pinyin: 'zgpa' },
            { code: 'hk02628', name: '中国人寿', pinyin: 'zgrys' },
            { code: 'hk01398', name: '工商银行', pinyin: 'gsyh' },
            { code: 'hk00388', name: '港交所', pinyin: 'gjs' },
            { code: 'hk00981', name: '中芯国际', pinyin: 'zxgj' },
            { code: 'hk00762', name: '中国联通', pinyin: 'zglt' },
            { code: 'hk01766', name: '中国中车', pinyin: 'zgzc' },
            { code: 'hk01093', name: '石药集团', pinyin: 'syjt' },
            { code: 'hk01109', name: '中国海外', pinyin: 'zghw' },
            { code: 'hk01777', name: '新澳能源', pinyin: 'xany' },
            { code: 'hk00241', name: '阿里健康', pinyin: 'aljk' },

            // 美股 - 热门股票
            { code: 'usAAPL', name: '苹果', pinyin: 'pingguo' },
            { code: 'usTSLA', name: '特斯拉', pinyin: 'tesila' },
            { code: 'usMSFT', name: '微软', pinyin: 'weiruan' },
            { code: 'usGOOGL', name: '谷歌', pinyin: 'guge' },
            { code: 'usAMZN', name: '亚马逊', pinyin: 'yamaxun' },
            { code: 'usMETA', name: 'Meta', pinyin: 'meta' },
            { code: 'usNVDA', name: '英伟达', pinyin: 'yingweida' },
            { code: 'usNFLX', name: 'Netflix', pinyin: 'netflix' },
            { code: 'usBABA', name: '阿里巴巴', pinyin: 'alibaba' },
            { code: 'usJD', name: '京东', pinyin: 'jingdong' },
            { code: 'usPDD', name: '拼多多', pinyin: 'pinduoduo' },
            { code: 'usBIDU', name: '百度', pinyin: 'baidu' },
            { code: 'usNTES', name: '网易', pinyin: 'wangyi' },
            { code: 'usNIO', name: '蔚来', pinyin: 'weilai' },
            { code: 'usXPEV', name: '小鹏', pinyin: 'xiaopeng' },
            { code: 'usLI', name: '理想', pinyin: 'lixian' }
        ];

        // 从本地数据库搜索股票
        function searchFromLocalDatabase(keyword) {
            keyword = keyword.toLowerCase().trim();

            return localStockDatabase.filter(stock => {
                // 匹配代码
                if (stock.code.toLowerCase().includes(keyword)) return true;
                // 匹配名称
                if (stock.name.includes(keyword)) return true;
                // 匹配拼音
                if (stock.pinyin.includes(keyword)) return true;
                return false;
            }).slice(0, 20);
        }

        // 云端同步配置
        const GIST_TOKEN_KEY = 'leeks_gist_token';
        const GIST_ID_KEY = 'leeks_gist_id';
        const GIST_OWNER_KEY = 'leeks_gist_owner';
        const AUTO_SYNC_KEY = 'leeks_auto_sync';
        let autoSyncEnabled = localStorage.getItem(AUTO_SYNC_KEY) === 'true';

        // 列配置
        const columnConfig = [
            { key: 'code', name: '编码', default: true },
            { key: 'name', name: '股票名称', default: true },
            { key: 'now', name: '当前价', default: true },
            { key: 'change', name: '涨跌', default: true },
            { key: 'changePercent', name: '涨跌幅', default: true },
            { key: 'volume', name: '成交量', default: true },
            { key: 'amount', name: '成交额', default: false },
            { key: 'time', name: '更新时间', default: false },
            { key: 'max', name: '最高价', default: false },
            { key: 'min', name: '最低价', default: false },
            { key: 'cost', name: '成本价', default: true },
            { key: 'bonds', name: '持仓', default: true },
            { key: 'marketValue', name: '持仓市值', default: true },
            { key: 'prediction', name: '预测趋势', default: true },
            { key: 'incomePercent', name: '收益率', default: true },
            { key: 'income', name: '收益', default: true },
            { key: 'targetPrice', name: '目标价', default: true },
            { key: 'stopLoss', name: '止损价', default: true },
            { key: 'status', name: '状态', default: true },
            { key: 'yieldToTarget', name: '目标收益', default: true },
            { key: 'yieldToStop', name: '止损损失', default: true },
            { key: 'riskRewardRatio', name: '盈亏比', default: true }
        ];

        // 确保 prediction 和成交量相关列在可见列中（兼容旧数据）
        let visibleColumns = JSON.parse(localStorage.getItem('leeks_visible_columns') || JSON.stringify(columnConfig.map(c => c.key)));
        if (!visibleColumns.includes('prediction') || !visibleColumns.includes('volume')) {
            visibleColumns = columnConfig.filter(c => c.default).map(c => c.key);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (stocks.length === 0) {
                // 添加默认示例股票
                stocks = [
                    { code: 'sh600519', name: '贵州茅台', cost: '1000', bonds: '100', targetPrice: '1200', stopLoss: '950' },
                    { code: 'sz000001', name: '平安银行', cost: '10', bonds: '1000', targetPrice: '12', stopLoss: '9' },
                    { code: 'sz000002', name: '万科A', cost: '20', bonds: '500', targetPrice: '25', stopLoss: '18' }
                ];
                saveStocks();
            }

            applyStealthMode();
            updateAutoRefreshButton();
            document.getElementById('refreshIntervalInput').value = refreshInterval;
            renderStocks();
            refreshStocks();

            // 启动自动刷新
            startAutoRefresh();

            // 绑定图表 Tab 点击事件
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    loadChart(currentChartStock, tab.dataset.type);
                });
            });

            // 点击其他地方关闭右键菜单
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.remove('active');
            });

            // 右键菜单项点击
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (currentChartStock) {
                        showChart(currentChartStock, item.dataset.type);
                    }
                });
            });

            // 初始化云端同步状态
            updateCloudSyncUI();

            // 初始化语音播报状态
            updateVoiceUI();
        });

        // 保存股票列表到 localStorage
        function saveStocks() {
            localStorage.setItem('leeks_stocks', JSON.stringify(stocks));

            // 如果开启自动同步，触发备份（不传入按钮元素，因为不是手动点击）
            if (autoSyncEnabled) {
                backupToGitHub(null);
            }
        }

        // 渲染股票表格
        function renderStocks() {
            const tbody = document.getElementById('stockTableBody');
            const thead = document.querySelector('.stock-table thead tr');

            // 应用过滤
            let filteredStocks = stocks.filter(stock => {
                // 状态过滤
                if (currentFilter !== 'all') {
                    // 盈利和亏损筛选只针对有持仓的股票
                    if (currentFilter === 'profit' || currentFilter === 'loss') {
                        if (!stock.bonds || stock.bonds === '--' || parseFloat(stock.bonds) <= 0) return false;
                        if (!stock.incomePercent || stock.incomePercent === '--') return false;
                        if (currentFilter === 'profit' && parseFloat(stock.incomePercent) <= 0) return false;
                        if (currentFilter === 'loss' && parseFloat(stock.incomePercent) >= 0) return false;
                    }
                    if (currentFilter === 'target') {
                        const now = parseFloat(stock.now);
                        const targetPrice = parseFloat(stock.targetPrice);
                        if (!now || !targetPrice || now < targetPrice) return false;
                    }
                }

                // 搜索过滤
                if (searchText) {
                    const search = searchText.toLowerCase();
                    if (!stock.code.toLowerCase().includes(search) && !stock.name.toLowerCase().includes(search)) {
                        return false;
                    }
                }

                return true;
            });

            if (filteredStocks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${visibleColumns.length + 1}" class="empty-state">
                            <div class="empty-state-icon">📈</div>
                            <div class="empty-state-text">${stocks.length === 0 ? '暂无股票，请添加股票代码' : '没有匹配的股票'}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 渲染表头
            thead.innerHTML = renderTableHeader();

            // 排序
            filteredStocks.sort((a, b) => {
                let valA = a[sortColumn] || '';
                let valB = b[sortColumn] || '';

                // 盈亏比特殊处理（从 "2.5:1" 中提取数字）
                if (sortColumn === 'riskRewardRatio') {
                    valA = valA !== '--' ? parseFloat(valA.split(':')[0]) || 0 : 0;
                    valB = valB !== '--' ? parseFloat(valB.split(':')[0]) || 0 : 0;
                }

                // 数值字段转换为数字比较
                if (['now', 'change', 'changePercent', 'max', 'min', 'cost', 'bonds', 'marketValue', 'incomePercent', 'income', 'targetPrice', 'stopLoss', 'yieldToTarget', 'yieldToStop', 'riskRewardRatio', 'volume', 'amount'].includes(sortColumn)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }

                if (sortDirection === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });

            // 更新表头排序指示器
            document.querySelectorAll('.stock-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(sortColumn)) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            tbody.innerHTML = filteredStocks.map(stock => {
                return `<tr data-code="${stock.code}" ondblclick="showChart('${stock.code}', 'min')" oncontextmenu="showContextMenu(event, '${stock.code}')">${renderTableCells(stock)}</tr>`;
            }).join('');

            // 更新统计
            updateTotalStats();
        }

        // 渲染表头
        function renderTableHeader() {
            return columnConfig
                .filter(col => visibleColumns.includes(col.key))
                .map(col => {
                    if (col.key === 'status') {
                        return `<th>状态</th>`;
                    }
                    return `<th onclick="sortTable('${col.key}')">${col.name}</th>`;
                })
                .join('') + '<th>操作</th>';
        }

        // 渲染表格单元格
        function renderTableCells(stock) {
            // 计算价格状态
            const now = parseFloat(stock.now);
            const targetPrice = parseFloat(stock.targetPrice);
            const stopLoss = parseFloat(stock.stopLoss);
            let priceStatus = 'neutral';
            let statusText = '--';

            // 计算目标价距离百分比
            let targetPercent = '--';
            if (!isNaN(now) && !isNaN(targetPrice) && targetPrice > 0 && now > 0) {
                targetPercent = ((targetPrice - now) / now * 100).toFixed(2);
            }

            // 计算止损价距离百分比
            let stopLossPercent = '--';
            if (!isNaN(now) && !isNaN(stopLoss) && stopLoss > 0 && now > 0) {
                stopLossPercent = ((stopLoss - now) / now * 100).toFixed(2);
            }

            // 计算目标收益比（目标价相对成本价的收益率）
            let yieldToTarget = '--';
            if (!isNaN(targetPrice) && stock.cost && stock.cost !== '--') {
                const cost = parseFloat(stock.cost);
                if (cost > 0) {
                    yieldToTarget = ((targetPrice - cost) / cost * 100).toFixed(2);
                }
            }

            // 计算止损损失比（止损价相对成本价的收益率）
            let yieldToStop = '--';
            if (!isNaN(stopLoss) && stock.cost && stock.cost !== '--') {
                const cost = parseFloat(stock.cost);
                if (cost > 0) {
                    yieldToStop = ((stopLoss - cost) / cost * 100).toFixed(2);
                }
            }

            // 计算盈亏比 = 目标收益绝对值 / 止损损失绝对值
            let riskRewardRatio = '--';
            if (yieldToTarget !== '--' && yieldToStop !== '--') {
                const targetYield = parseFloat(yieldToTarget);
                const stopLossYield = parseFloat(yieldToStop);
                if (targetYield > 0 && stopLossYield < 0) {
                    riskRewardRatio = (targetYield / Math.abs(stopLossYield)).toFixed(2) + ':1';
                }
            }

            if (!isNaN(now) && !isNaN(targetPrice) && targetPrice > 0) {
                if (now >= targetPrice) {
                    priceStatus = 'target';
                    statusText = '已达目标';
                }
            }
            if (!isNaN(now) && !isNaN(stopLoss) && stopLoss > 0) {
                if (now <= stopLoss) {
                    priceStatus = 'stop';
                    statusText = '已触发止损';
                }
            }
            // 只有持仓有值时才显示"持有中"
            if (priceStatus === 'neutral' && (!isNaN(targetPrice) || !isNaN(stopLoss))) {
                if (stock.bonds && stock.bonds !== '--' && parseFloat(stock.bonds) > 0) {
                    statusText = '持有中';
                }
            }

            // 计算持仓市值
            let marketValue = '--';
            if (!isNaN(now) && stock.bonds && stock.bonds !== '--') {
                const bonds = parseFloat(stock.bonds);
                marketValue = (now * bonds).toFixed(2);
            }

            // 涨跌预测（基于涨跌幅、价格位置和成交量）
            let prediction = '--';
            let predictionClass = 'gray';
            let predictionRule = '';
            if (!isNaN(now) && !isNaN(stock.max) && !isNaN(stock.min) && !isNaN(stock.changePercent)) {
                const max = parseFloat(stock.max);
                const min = parseFloat(stock.min);
                const changePercent = parseFloat(stock.changePercent);

                // 计算价格位置
                const pricePosition = (now - min) / (max - min);

                // 获取成交量用于综合判断
                const volume = parseFloat(stock.volume) || 0;

                // 根据股价获取对应的成交量阈值（复用 formatVolume 中的逻辑）
                const getVolumeThresholds = () => {
                    let multiplier;
                    if (now > 200) {
                        multiplier = 0.5;
                    } else if (now > 100) {
                        multiplier = 0.8;
                    } else if (now > 50) {
                        multiplier = 1.0;
                    } else if (now > 20) {
                        multiplier = 1.5;
                    } else if (now > 10) {
                        multiplier = 2.0;
                    } else {
                        multiplier = 3.0;
                    }
                    return {
                        normalVolume: Math.floor(10000 * multiplier),
                        highVolume: Math.floor(50000 * multiplier),
                        hugeVolume: Math.floor(100000 * multiplier)
                    };
                };

                const volumeThresholds = getVolumeThresholds();
                const isHighVolume = volume >= volumeThresholds.highVolume;
                const isHugeVolume = volume >= volumeThresholds.hugeVolume;
                const isLowVolume = volume < volumeThresholds.normalVolume;

                // 计算距离最高价的空间（冲高回落的关键指标）
                const distanceToMax = max > 0 ? ((max - now) / max * 100) : 0;

                // 冲高回落预警 - 降低阈值，提前预警
                const isBigRise = changePercent > 2.5;
                const isNearTop = pricePosition > 0.75;

                if (isBigRise && isNearTop) {
                    // 情况1：大幅上涨+接近高点+巨量（可能是诱多）
                    if (isHugeVolume) {
                        prediction = '⚠️ 冲高回落';
                        predictionClass = 'gray';
                        predictionRule = `涨幅${changePercent.toFixed(2)}% > 2.5%，价格位置${(pricePosition * 100).toFixed(0)}% > 75%，巨量${volume}手`;
                    }
                    // 情况2：大幅上涨+接近高点但缩量（可能乏力）
                    else if (isLowVolume && changePercent > 4) {
                        prediction = '⚠️ 冲高回落';
                        predictionClass = 'gray';
                        predictionRule = `涨幅${changePercent.toFixed(2)}% > 4%，价格位置${(pricePosition * 100).toFixed(0)}% > 75%，缩量${volume}手`;
                    }
                    // 情况3：大幅上涨+接近高点+放量（强势）
                    else if (isHighVolume) {
                        prediction = '📈 强势';
                        predictionClass = 'red';
                        predictionRule = `涨幅${changePercent.toFixed(2)}% > 2.5%，价格位置${(pricePosition * 100).toFixed(0)}% > 75%，放量${volume}手`;
                    }
                    else {
                        prediction = '📈 强势';
                        predictionClass = 'red';
                        predictionRule = `涨幅${changePercent.toFixed(2)}% > 2.5%，价格位置${(pricePosition * 100).toFixed(0)}% > 75%`;
                    }
                }
                // 新增：高位滞涨预警（涨幅一般但位置很高）
                else if (changePercent > 0.5 && changePercent <= 2.5 && pricePosition > 0.85) {
                    prediction = '⚠️ 高位滞涨';
                    predictionClass = 'gray';
                    predictionRule = `价格位置${(pricePosition * 100).toFixed(0)}% > 85%，但涨幅仅${changePercent.toFixed(2)}%`;
                }
                // 新增：量价背离预警
                else if (changePercent > 2 && pricePosition > 0.65 && isLowVolume) {
                    prediction = '⚠️ 量价背离';
                    predictionClass = 'gray';
                    predictionRule = `涨幅${changePercent.toFixed(2)}% > 2%，但缩量${volume}手，可能乏力`;
                }
                // 强势上涨
                else if (changePercent > 1.5 && pricePosition > 0.6) {
                    prediction = '📈 强势';
                    predictionClass = 'red';
                    predictionRule = `涨幅${changePercent.toFixed(2)}% > 1.5%，价格位置${(pricePosition * 100).toFixed(0)}% > 60%`;
                }
                // 上涨
                else if (changePercent > 0 && pricePosition > 0.5) {
                    prediction = '↗️ 上涨';
                    predictionClass = 'red';
                    predictionRule = `涨幅${changePercent.toFixed(2)}%，价格位置${(pricePosition * 100).toFixed(0)}% > 50%`;
                }
                // 弱势
                else if (changePercent < -2 && pricePosition < 0.4) {
                    prediction = '⚠️ 弱势';
                    predictionClass = 'green';
                    predictionRule = `跌幅${Math.abs(changePercent).toFixed(2)}% > 2%，价格位置${(pricePosition * 100).toFixed(0)}% < 40%`;
                }
                // 下跌
                else if (changePercent < 0 && pricePosition < 0.5) {
                    prediction = '↘️ 下跌';
                    predictionClass = 'green';
                    predictionRule = `跌幅${Math.abs(changePercent).toFixed(2)}%，价格位置${(pricePosition * 100).toFixed(0)}% < 50%`;
                }
                // 震荡
                else if (Math.abs(changePercent) < 1) {
                    prediction = '➡️ 震荡';
                    predictionClass = 'gray';
                    predictionRule = `涨跌幅${Math.abs(changePercent).toFixed(2)}% < 1%`;
                }
                else if (pricePosition > 0.5 && changePercent > 0) {
                    prediction = '📈 上涨';
                    predictionClass = 'red';
                    predictionRule = `价格位置${(pricePosition * 100).toFixed(0)}% > 50%，涨幅${changePercent.toFixed(2)}%`;
                }
                else if (pricePosition < 0.5 && changePercent < 0) {
                    prediction = '📉 下跌';
                    predictionClass = 'green';
                    predictionRule = `价格位置${(pricePosition * 100).toFixed(0)}% < 50%，跌幅${Math.abs(changePercent).toFixed(2)}%`;
                }
                else {
                    prediction = '➡️ 震荡';
                    predictionClass = 'gray';
                    predictionRule = `价格位置${(pricePosition * 100).toFixed(0)}%，涨跌幅${changePercent.toFixed(2)}%`;
                }
            }

            // 单元格映射
            const cellMap = {
                code: `<td>${stock.code}</td>`,
                name: `<td>${stealthMode ? toPinyin(stock.name) : stock.name}</td>`,
                now: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${stock.now || '--'}</td>`,
                change: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${formatChange(stock.change)}</td>`,
                changePercent: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${formatChangePercent(stock.changePercent)}</td>`,
                volume: formatVolume(stock.volume, stock.changePercent, stock.code),
                amount: formatAmount(stock.amount),
                time: `<td>${formatTime(stock.time)}</td>`,
                max: `<td>${stock.max || '--'}</td>`,
                min: `<td>${stock.min || '--'}</td>`,
                cost: `<td class="editable" onclick="event.stopPropagation(); openEditPopup('${stock.code}')">${stock.cost || '--'}</td>`,
                bonds: `<td class="editable" onclick="event.stopPropagation(); openEditPopup('${stock.code}')">${stock.bonds || '--'}</td>`,
                marketValue: `<td class="price-tooltip" data-tooltip="当前价 × 持仓数量">${marketValue}</td>`,
                prediction: `<td class="${predictionClass} price-tooltip" data-tooltip="${predictionRule || '数据不足，无法预测'}">${prediction}</td>`,
                incomePercent: `<td class="${stock.incomePercent >= 0 ? 'red' : stock.incomePercent < 0 ? 'green' : 'gray'}">${formatChangePercent(stock.incomePercent)}</td>`,
                income: `<td class="${stock.income >= 0 ? 'red' : stock.income < 0 ? 'green' : 'gray'}">${formatIncome(stock.income)}</td>`,
                targetPrice: `<td class="editable price-tooltip" onclick="event.stopPropagation(); openEditPopup('${stock.code}')"
                    data-tooltip="距离当前价: ${targetPercent !== '--' ? (targetPercent > 0 ? '+' : '') + targetPercent + '%' : '--'}">${stock.targetPrice || '--'}</td>`,
                stopLoss: `<td class="editable price-tooltip" onclick="event.stopPropagation(); openEditPopup('${stock.code}')"
                    data-tooltip="距离当前价: ${stopLossPercent !== '--' ? (stopLossPercent > 0 ? '+' : '') + stopLossPercent + '%' : '--'}">${stock.stopLoss || '--'}</td>`,
                status: `<td><span class="price-status ${priceStatus}">${statusText}</span></td>`,
                yieldToTarget: `<td class="${yieldToTarget >= 0 ? 'red' : yieldToTarget < 0 ? 'green' : 'gray'}">${formatChangePercent(yieldToTarget)}</td>`,
                yieldToStop: `<td class="${yieldToStop >= 0 ? 'red' : yieldToStop < 0 ? 'green' : 'gray'}">${formatChangePercent(yieldToStop)}</td>`,
                riskRewardRatio: `<td class="price-tooltip" data-tooltip="${riskRewardRatio !== '--' ? '收益潜力是风险的 ' + riskRewardRatio.split(':')[0] + ' 倍' : '--'}">${riskRewardRatio}</td>`
            };

            return columnConfig
                .filter(col => visibleColumns.includes(col.key))
                .map(col => cellMap[col.key] || '')
                .join('') + '<td><button class="toolbar-btn delete-btn" onclick="deleteStock(\'' + stock.code + '\', event)">删除</button></td>';
        }

        // 更新总资产统计
        function updateTotalStats() {
            let totalMarketValue = 0;
            let totalIncome = 0;
            let hasData = false;

            stocks.forEach(stock => {
                const now = parseFloat(stock.now);
                const bonds = stock.bonds && stock.bonds !== '--' ? parseFloat(stock.bonds) : 0;
                const income = stock.income && stock.income !== '--' ? parseFloat(stock.income) : 0;

                if (!isNaN(now) && bonds > 0) {
                    totalMarketValue += now * bonds;
                    hasData = true;
                }

                if (!isNaN(income)) {
                    totalIncome += income;
                }
            });

            const marketValueEl = document.getElementById('totalMarketValue');
            const incomeEl = document.getElementById('totalIncome');

            if (hasData) {
                marketValueEl.textContent = `总市值: ${totalMarketValue.toFixed(2)}`;
                marketValueEl.className = totalIncome >= 0 ? 'red' : 'green';
                incomeEl.textContent = `总收益: ${totalIncome >= 0 ? '+' : ''}${totalIncome.toFixed(2)}`;
                incomeEl.className = totalIncome >= 0 ? 'red' : 'green';
            } else {
                marketValueEl.textContent = '总市值: --';
                marketValueEl.className = '';
                incomeEl.textContent = '总收益: --';
                incomeEl.className = '';
            }
        }

        // 搜索过滤
        function filterStocks() {
            searchText = document.getElementById('searchInput').value.trim();
            renderStocks();
        }

        // 状态过滤
        function filterByStatus(status) {
            currentFilter = status;
            renderStocks();
        }

        // 格式化涨跌
        function formatChange(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}` : value.toFixed(2);
        }

        // 格式化涨跌幅
        function formatChangePercent(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}%` : `${value.toFixed(2)}%`;
        }

        // 格式化时间
        function formatTime(time) {
            if (!time) return '--';
            return time.substring(8);
        }

        // 格式化收益
        function formatIncome(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}` : value.toFixed(2);
        }

        // 格式化成交量（手），根据涨跌幅和成交量的变化显示颜色
        function formatVolume(volume, changePercent, code) {
            if (!volume || volume === '--') return '<td>--</td>';

            const volumeNum = parseFloat(volume);
            const change = parseFloat(changePercent) || 0;
            let colorClass = 'gray';
            let tooltip = '';

            // 根据股价获取对应的成交量阈值
            const getVolumeThresholds = (code) => {
                const stocksData = stocks.find(s => s.code === code);
                const price = stocksData ? parseFloat(stocksData.now) || 0 : 0;

                // 股价越高，成交量阈值越低（因为高价股通常每笔交易的手数较少）
                // 低价股需要更高的成交量才能算"放量"
                let multiplier;
                if (price > 200) {
                    multiplier = 0.5;   // 超高价股（如茅台 >1500元）
                } else if (price > 100) {
                    multiplier = 0.8;   // 高价股
                } else if (price > 50) {
                    multiplier = 1.0;   // 中高价股
                } else if (price > 20) {
                    multiplier = 1.5;   // 中价股
                } else if (price > 10) {
                    multiplier = 2.0;   // 中低价股
                } else {
                    multiplier = 3.0;   // 低价股（<10元）
                }

                return {
                    normalVolume: Math.floor(10000 * multiplier),    // 基础量：1万手 × 系数
                    highVolume: Math.floor(50000 * multiplier),     // 明显放量：5万手 × 系数
                    hugeVolume: Math.floor(100000 * multiplier),    // 巨量：10万手 × 系数
                    multiplier: multiplier
                };
            };

            const thresholds = getVolumeThresholds(code);

            // 放量判断（根据股价动态调整阈值）
            // 1. 大幅波动
            if (Math.abs(change) > 3) {
                colorClass = change > 0 ? 'red' : 'green';
                tooltip = `涨跌幅${change.toFixed(2)}% > 3%，${change > 0 ? '大幅上涨' : '大幅下跌'}`;
            }
            // 2. 中等波动且有较大成交量
            else if (Math.abs(change) > 1.5 && volumeNum > thresholds.normalVolume) {
                colorClass = change > 0 ? 'red' : 'green';
                tooltip = `涨跌幅${change.toFixed(2)}% > 1.5%，成交量${volumeNum}手 > ${thresholds.normalVolume}手`;
            }
            // 3. 小幅波动但巨量
            else if (Math.abs(change) > 0.5 && volumeNum > thresholds.hugeVolume) {
                colorClass = change > 0 ? 'red' : 'green';
                tooltip = `涨跌幅${change.toFixed(2)}% > 0.5%，巨量${volumeNum}手（>${(thresholds.hugeVolume / 10000).toFixed(0)}万手）`;
            }
            // 4. 正常波动
            else if (Math.abs(change) > 0.1) {
                colorClass = change > 0 ? 'red' : 'green';
                tooltip = `涨跌幅${change.toFixed(2)}%，正常波动`;
            }
            // 5. 平盘或波动极小
            else {
                tooltip = `涨跌幅${change.toFixed(2)}%，波动极小`;
            }

            // 格式化成交量（万手显示）
            let displayVolume = volumeNum;
            if (volumeNum >= 10000) {
                displayVolume = (volumeNum / 10000).toFixed(2) + '万';
            }

            return `<td class="${colorClass} price-tooltip" data-tooltip="${tooltip}">${displayVolume}</td>`;
        }

        // 格式化成交额（万元）
        function formatAmount(amount) {
            if (!amount || amount === '--') return '<td>--</td>';

            const amountNum = parseFloat(amount);
            let displayAmount = amountNum;

            if (amountNum >= 10000) {
                displayAmount = (amountNum / 10000).toFixed(2) + '亿';
            } else if (amountNum >= 1) {
                displayAmount = amountNum.toFixed(2) + '万';
            }

            return `<td>${displayAmount}</td>`;
        }

        // 拼音转换（简化版）
        function toPinyin(text) {
            // 简化实现：实际应该使用拼音库
            const pinyinMap = {
                '贵州茅台': 'Guizhou Maotai',
                '平安银行': 'Ping An Bank',
                '万科A': 'Vanke A',
                '英威腾': 'Invt'
            };
            return pinyinMap[text] || text;
        }

        // 添加股票
        function addStock() {
            const input = document.getElementById('stockInput');
            const value = input.value.trim();

            if (!value) {
                alert('请输入股票代码');
                return;
            }

            // 解析输入（支持格式: code 或 code,cost,bonds）
            const parts = value.split(',').map(s => s.trim());
            let code = parts[0];
            const cost = parts[1] || '--';
            const bonds = parts[2] || '--';

            // 如果是纯中文或数字，尝试从选中项获取完整代码
            if (!code.match(/^[a-zA-Z]{2}\d+/) && !code.match(/^[a-zA-Z]{2}[A-Z]+/)) {
                // 尝试将输入转换为股票代码
                code = convertToStockCode(code);
                if (!code) {
                    alert('股票代码格式错误，请使用: sh600519, sz000001, hk00700, usAAPL 或选择建议列表中的股票');
                    return;
                }
            }

            // 验证股票代码格式
            const prefix = code.substring(0, 2).toLowerCase();
            if (!['sh', 'sz', 'hk', 'us'].includes(prefix)) {
                alert('股票代码格式错误，请使用: sh600519, sz000001, hk00700, usAAPL');
                return;
            }

            // 检查是否已存在
            if (stocks.find(s => s.code === code)) {
                alert('该股票已存在');
                return;
            }

            stocks.push({
                code,
                name: '--',
                cost,
                bonds,
                now: '--',
                change: '--',
                changePercent: '--',
                time: '--',
                max: '--',
                min: '--',
                incomePercent: '--',
                income: '--',
                targetPrice: '--',
                stopLoss: '--'
            });

            saveStocks();
            renderStocks();
            refreshStocks();

            input.value = '';
            hideSuggestions();
        }

        // 将输入转换为股票代码
        function convertToStockCode(input) {
            input = input.trim().toUpperCase();

            // 检查是否是标准代码格式
            if (/^[A-Z]{2}\d+$/.test(input) || /^[A-Z]{2}[A-Z]+$/.test(input)) {
                return input.toLowerCase();
            }

            // 简单映射常见股票名称到代码
            const nameToCodeMap = {
                '茅台': 'sh600519',
                '贵州茅台': 'sh600519',
                '平安银行': 'sz000001',
                '万科': 'sz000002',
                '万科A': 'sz000002',
                '平安': 'sh601318',
                '中国平安': 'sh601318',
                '腾讯': 'hk00700',
                '腾讯控股': 'hk00700',
                '阿里': 'hk09988',
                '阿里巴巴': 'hk09988',
                '美团': 'hk03690',
                '小米': 'hk01810',
                '比亚迪': 'sz002594',
                '宁德时代': 'sz300750',
                '招商银行': 'sh600036',
                '五粮液': 'sh000858',
                '苹果': 'usAAPL',
                '特斯拉': 'usTSLA',
                '微软': 'usMSFT',
                '谷歌': 'usGOOGL',
                '亚马逊': 'usAMZN'
            };

            return nameToCodeMap[input] || null;
        }

        // 处理股票输入，显示搜索建议
        async function handleStockInput(event) {
            const input = event.target;
            const value = input.value.trim();
            const dropdown = document.getElementById('suggestionsDropdown');

            // 清除之前的定时器
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // 输入为空时隐藏建议
            if (value.length === 0) {
                hideSuggestions();
                return;
            }

            // 如果已经是标准代码格式，不搜索建议
            if (/^[a-zA-Z]{2}\d+$/.test(value) || /^[a-zA-Z]{2}[A-Z]+$/.test(value)) {
                hideSuggestions();
                return;
            }

            // 显示加载状态
            dropdown.innerHTML = '<div class="suggestion-loading">搜索中...</div>';
            dropdown.classList.add('active');

            // 防抖处理
            searchTimeout = setTimeout(async () => {
                try {
                    // 使用免费API搜索股票
                    dropdown.innerHTML = '<div class="suggestion-loading">搜索中...</div>';
                    dropdown.classList.add('active');

                    const suggestions = await searchStockSuggestions(value);
                    showSuggestions(suggestions);
                } catch (error) {
                    console.error('搜索股票失败:', error);
                    dropdown.innerHTML = '<div class="suggestion-no-result">搜索失败，请稍后重试<br><small>错误: ' + error.message + '</small></div>';
                }
            }, 300);
        }

        // 搜索股票建议
        async function searchStockSuggestions(keyword) {
            // 如果本地数据库有匹配，直接返回
            const localResults = searchFromLocalDatabase(keyword);
            if (localResults.length > 0) {
                return localResults;
            }

            // 如果本地没有匹配，尝试在线搜索
            return new Promise((resolve) => {
                try {
                    // 创建script标签实现JSONP
                    const script = document.createElement('script');

                    // 设置超时计时器
                    const timeoutId = setTimeout(() => {
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        // 清理全局变量
                        if (window.suggestdata) {
                            delete window.suggestdata;
                        }
                        console.log('在线搜索超时，使用本地数据库');
                        resolve(searchFromLocalDatabase(keyword));
                    }, 3000); // 3秒超时

                    // 监听script加载完成，检查全局变量
                    script.onload = function() {
                        clearTimeout(timeoutId);

                        try {
                            // 新浪API会设置全局变量 window.suggestdata
                            // 数据格式：var suggestdata="华胜天成,11,600410,sh600410,华胜天成,,华胜天成,99,1,,,";
                            const rawData = window.suggestdata;

                            // 移除script标签
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            // 清理全局变量
                            delete window.suggestdata;

                            // 验证数据有效性
                            if (!rawData || rawData === '' || typeof rawData !== 'string') {
                                console.log('在线搜索无结果，使用本地数据库');
                                resolve(searchFromLocalDatabase(keyword));
                                return;
                            }

                            // 检查是否为无效的错误数据（如哈希值等）
                            if (/^[a-f0-9]{32}$/.test(rawData) || rawData.length < 10 || !rawData.includes(',')) {
                                console.log('收到无效数据格式，使用本地数据库');
                                console.log('无效数据:', rawData);
                                resolve(searchFromLocalDatabase(keyword));
                                return;
                            }

                            console.log('收到API数据:', rawData);

                            // 解析返回的数据
                            const results = [];
                            const items = rawData.split(';').filter(item => item.trim());

                            items.forEach(item => {
                                const parts = item.split(',');
                                // 数据格式：名称,市场类型,数字代码,完整代码,名称,市场类型,拼音,其他字段...
                                // parts[0] = 名称 (华胜天成)
                                // parts[1] = 市场类型 (11)
                                // parts[2] = 数字代码 (600410)
                                // parts[3] = 完整代码 (sh600410)
                                // parts[4] = 名称 (华胜天成)
                                if (parts.length >= 5 && parts[3]) {
                                    results.push({
                                        code: parts[3],
                                        name: parts[0] || parts[4] || '',
                                        market: parts[1]
                                    });
                                }
                            });

                            if (results.length > 0) {
                                console.log('在线搜索成功:', results);
                                resolve(results.slice(0, 20));
                            } else {
                                console.log('解析后无结果，使用本地数据库');
                                resolve(searchFromLocalDatabase(keyword));
                            }
                        } catch (error) {
                            console.error('解析搜索结果失败:', error);
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            if (window.suggestdata) {
                                delete window.suggestdata;
                            }
                            resolve(searchFromLocalDatabase(keyword));
                        }
                    };

                    // 设置错误处理
                    script.onerror = function() {
                        clearTimeout(timeoutId);
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        if (window.suggestdata) {
                            delete window.suggestdata;
                        }
                        console.error('搜索请求失败，使用本地数据库');
                        resolve(searchFromLocalDatabase(keyword));
                    };

                    // 构建请求URL
                    script.src = `https://suggest3.sinajs.cn/suggest/type=11,12,13,14,15&key=${encodeURIComponent(keyword)}&name=suggestdata&_t=${Date.now()}`;

                    document.body.appendChild(script);
                } catch (error) {
                    console.error('在线搜索异常，使用本地数据库:', error);
                    resolve(searchFromLocalDatabase(keyword));
                }
            });
        }

        // 显示搜索建议
        function showSuggestions(suggestions) {
            const dropdown = document.getElementById('suggestionsDropdown');

            if (suggestions.length === 0) {
                dropdown.innerHTML = '<div class="suggestion-no-result">未找到匹配的股票</div>';
                dropdown.classList.add('active');
                return;
            }

            dropdown.innerHTML = suggestions.map(item => `
                <div class="suggestion-item" onclick="selectSuggestion('${item.code}')">
                    <span class="suggestion-code">${item.code}</span>
                    <span class="suggestion-name">${item.name}</span>
                </div>
            `).join('');

            dropdown.classList.add('active');
        }

        // 隐藏搜索建议
        function hideSuggestions() {
            const dropdown = document.getElementById('suggestionsDropdown');
            dropdown.classList.remove('active');
            dropdown.innerHTML = '';
        }

        // 选择建议项
        function selectSuggestion(code) {
            const input = document.getElementById('stockInput');
            input.value = code;
            hideSuggestions();
            input.focus();
        }

        // 点击其他地方隐藏建议
        document.addEventListener('click', (event) => {
            const stockInput = document.getElementById('stockInput');
            const dropdown = document.getElementById('suggestionsDropdown');

            if (!stockInput.contains(event.target) && !dropdown.contains(event.target)) {
                hideSuggestions();
            }
        });

        // 删除股票
        function deleteStock(code, event) {
            event.stopPropagation();
            if (confirm(`确定要删除 ${code} 吗？`)) {
                stocks = stocks.filter(s => s.code !== code);
                saveStocks();
                renderStocks();
            }
        }

        // 清空所有股票
        function clearAllStocks() {
            if (stocks.length === 0) {
                alert('股票列表已为空');
                return;
            }
            if (confirm('确定要清空所有股票吗？')) {
                stocks = [];
                saveStocks();
                renderStocks();
            }
        }

        // 刷新股票数据
        async function refreshStocks() {
            if (stocks.length === 0) return;

            const codes = stocks.map(s => s.code.split(',')[0]).join(',');
            if (!codes) return;

            try {
                const response = await fetch(`https://qt.gtimg.cn/q=${codes}`);
                const arrayBuffer = await response.arrayBuffer();
                const decoder = new TextDecoder('GBK');
                const text = decoder.decode(arrayBuffer);
                parseStockData(text);
            } catch (error) {
                console.error('刷新失败:', error);
            }

            // 更新刷新时间
            const now = new Date();
            document.getElementById('refreshInfo').textContent = `最后刷新: ${now.toLocaleTimeString()}`;

            // 更新总资产统计
            updateTotalStats();

            // 价格提醒
            checkPriceAlerts();
        }

        // 价格提醒检查
        function checkPriceAlerts() {
            stocks.forEach(stock => {
                const now = parseFloat(stock.now);
                const targetPrice = parseFloat(stock.targetPrice);
                const stopLoss = parseFloat(stock.stopLoss);

                // 检查是否达到目标价
                if (!isNaN(now) && !isNaN(targetPrice) && targetPrice > 0) {
                    if (now >= targetPrice && !stock.alertedTarget) {
                        showToast(`${stock.name} 已达到目标价 ${targetPrice}！`);
                        stock.alertedTarget = true;
                    } else if (now < targetPrice * 0.99) {
                        stock.alertedTarget = false;
                    }
                }

                // 检查是否触发止损
                if (!isNaN(now) && !isNaN(stopLoss) && stopLoss > 0) {
                    if (now <= stopLoss && !stock.alertedStop) {
                        showToast(`${stock.name} 已触发止损价 ${stopLoss}！`);
                        stock.alertedStop = true;
                    } else if (now > stopLoss * 1.01) {
                        stock.alertedStop = false;
                    }
                }
            });
            saveStocks();
        }

        // 解析股票数据
        function parseStockData(text) {
            const lines = text.split('\n');

            lines.forEach(line => {
                if (!line.includes('~')) return;

                // 支持普通股票和指数（如 sh000001, sz399001）
                const codeMatch = line.match(/v_([a-z]{2}\d{4,6})/);
                if (!codeMatch) return;

                const code = codeMatch[1];
                const values = line.split('~');

                const stock = stocks.find(s => s.code === code);
                if (stock) {
                    stock.name = values[1] || '--';
                    stock.now = values[3] || '--';
                    stock.change = values[31] || '--';
                    stock.changePercent = values[32] || '--';
                    stock.time = values[30] || '--';
                    stock.max = values[33] || '--';
                    stock.min = values[34] || '--';

                    // 成交量数据
                    // values[36]: 成交量（手）
                    // values[37]: 成交额（万元）
                    stock.volume = values[36] || '--';
                    stock.amount = values[37] || '--';

                    // 计算换手率（需要流通股本，暂无法获取，设为'--'）
                    // 换手率 = 成交量(手) / 流通股本(万股) * 100
                    stock.turnover = '--';

                    // 计算收益
                    if (stock.cost && stock.cost !== '--' && parseFloat(stock.cost) > 0) {
                        const cost = parseFloat(stock.cost);
                        const now = parseFloat(stock.now);
                        if (!isNaN(now)) {
                            const income = (now - cost);
                            stock.incomePercent = ((income / cost) * 100).toFixed(2);

                            if (stock.bonds && stock.bonds !== '--') {
                                const bonds = parseFloat(stock.bonds);
                                stock.income = (income * bonds).toFixed(2);
                            }
                        }
                    }
                }
            });

            saveStocks();
            renderStocks();
        }

        // 排序表格
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            localStorage.setItem('leeks_sort_column', sortColumn);
            localStorage.setItem('leeks_sort_direction', sortDirection);

            renderStocks();
        }

        // 显示图表
        function showChart(code, type) {
            currentChartStock = code;
            const prefix = code.substring(0, 2).toLowerCase();
            const stock = stocks.find(s => s.code === code);
            const name = stock ? stock.name : code;

            document.getElementById('chartTitle').textContent = `${name} (${code})`;

            // 更新 Tab 状态
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });

            loadChart(code, type);
            document.getElementById('chartPopup').classList.add('active');
        }

        // 加载图表
        function loadChart(code, type) {
            const prefix = code.substring(0, 2).toLowerCase();
            const timestamp = Date.now();
            let url = '';

            if (prefix === 'sh' || prefix === 'sz') {
                url = `https://image.sinajs.cn/newchart/${type}/n/${code}.gif?${timestamp}`;
            } else if (prefix === 'us') {
                if (type === 'min') {
                    url = `https://image.sinajs.cn/newchart/png/${type}/${prefix}/${code.substring(2)}.png?${timestamp}`;
                } else {
                    url = `https://image.sinajs.cn/newchart/${prefix}stock/${type}/${code.substring(2)}.gif?${timestamp}`;
                }
            } else if (prefix === 'hk') {
                if (type === 'min') {
                    url = `https://image.sinajs.cn/newchart/png/${type}/${prefix}/${code.substring(2)}.png?${timestamp}`;
                } else {
                    url = `https://image.sinajs.cn/newchart/${prefix}_stock/${type}/${code.substring(2)}.gif?${timestamp}`;
                }
            }

            // 重置图表内容区域
            const content = document.getElementById('chartContent');
            content.innerHTML = '<img id="chartImage" src="" alt="股票图表" style="display: none;">';

            const img = document.getElementById('chartImage');
            if (!img) {
                showChartError('图表元素加载失败');
                return;
            }

            img.src = url;

            // 图片加载错误处理
            img.onerror = function() {
                showChartError('图表加载失败，该股票可能暂无图表数据');
            };

            img.onload = function() {
                this.style.display = 'block';
            };
        }

        // 显示图表错误
        function showChartError(message) {
            const content = document.getElementById('chartContent');
            content.innerHTML = `
                <div class="chart-error">
                    <p>${message}</p>
                    <p style="font-size: 12px; margin-top: 10px; color: #999;">
                        指数、停牌股票可能无法显示图表
                    </p>
                </div>
            `;
        }

        // 关闭图表
        function closeChart(event) {
            if (!event || event.target === document.getElementById('chartPopup')) {
                document.getElementById('chartPopup').classList.remove('active');
                currentChartStock = null;
            }
        }

        // 显示右键菜单
        function showContextMenu(event, code) {
            event.preventDefault();
            currentChartStock = code;

            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('active');
        }

        // 编辑相关功能
        let editingStockCode = null;

        // 打开编辑弹窗
        function openEditPopup(code) {
            editingStockCode = code;
            const stock = stocks.find(s => s.code === code);

            if (!stock) return;

            document.getElementById('editCode').value = stock.code;
            document.getElementById('editName').value = stock.name;
            document.getElementById('editCost').value = stock.cost && stock.cost !== '--' ? stock.cost : '';
            document.getElementById('editBonds').value = stock.bonds && stock.bonds !== '--' ? stock.bonds : '';
            document.getElementById('editTargetPrice').value = stock.targetPrice && stock.targetPrice !== '--' ? stock.targetPrice : '';
            document.getElementById('editStopLoss').value = stock.stopLoss && stock.stopLoss !== '--' ? stock.stopLoss : '';

            document.getElementById('editPopup').querySelector('.chart-container').classList.add('edit-container');
            document.getElementById('editPopup').classList.add('active');

            // 聚焦到成本价输入框
            setTimeout(() => {
                document.getElementById('editCost').focus();
            }, 100);
        }

        // 关闭编辑弹窗
        function closeEditPopup(event) {
            if (!event || event.target === document.getElementById('editPopup')) {
                document.getElementById('editPopup').classList.remove('active');
                editingStockCode = null;
            }
        }

        // 保存编辑
        function saveEdit() {
            if (!editingStockCode) return;

            const stock = stocks.find(s => s.code === editingStockCode);
            if (!stock) return;

            const cost = document.getElementById('editCost').value.trim();
            const bonds = document.getElementById('editBonds').value.trim();
            const targetPrice = document.getElementById('editTargetPrice').value.trim();
            const stopLoss = document.getElementById('editStopLoss').value.trim();

            stock.cost = cost || '--';
            stock.bonds = bonds || '--';
            stock.targetPrice = targetPrice || '--';
            stock.stopLoss = stopLoss || '--';

            // 重新计算收益
            if (cost && cost !== '--' && parseFloat(cost) > 0) {
                const costValue = parseFloat(cost);
                const now = parseFloat(stock.now);
                if (!isNaN(now)) {
                    const income = (now - costValue);
                    stock.incomePercent = ((income / costValue) * 100).toFixed(2);

                    if (bonds && bonds !== '--') {
                        const bondsValue = parseFloat(bonds);
                        stock.income = (income * bondsValue).toFixed(2);
                    } else {
                        stock.income = '--';
                    }
                }
            } else {
                stock.incomePercent = '--';
                stock.income = '--';
            }

            saveStocks();
            renderStocks();
            closeEditPopup();
            showToast('保存成功！');
        }

        // 自动刷新
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            if (autoRefreshEnabled) {
                const interval = refreshInterval * 1000;
                refreshTimer = setInterval(refreshStocks, interval);
            }
        }

        // 修改刷新间隔
        function changeRefreshInterval(value) {
            let interval = parseInt(value);
            if (isNaN(interval) || interval < 3) interval = 3;
            if (interval > 300) interval = 300;
            refreshInterval = interval;
            localStorage.setItem('leeks_refresh_interval', interval);
            document.getElementById('refreshIntervalInput').value = interval;
            startAutoRefresh();
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            localStorage.setItem('leeks_auto_refresh', autoRefreshEnabled);
            updateAutoRefreshButton();
            startAutoRefresh();
        }

        function updateAutoRefreshButton() {
            const btn = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            btn.textContent = autoRefreshEnabled ? '自动刷新: 开' : '自动刷新: 关';
            indicator.classList.toggle('paused', !autoRefreshEnabled);
        }

        // 隐蔽模式
        function toggleStealthMode() {
            stealthMode = !stealthMode;
            localStorage.setItem('leeks_stealth_mode', stealthMode);
            applyStealthMode();
            renderStocks();
        }

        function applyStealthMode() {
            const btn = document.getElementById('stealthModeBtn');
            const pageTitle = document.getElementById('pageTitle');

            btn.textContent = stealthMode ? '隐蔽模式: 开' : '隐蔽模式: 关';
            btn.classList.toggle('active', stealthMode);
            document.body.classList.toggle('stealth-mode', stealthMode);

            // 伪装窗口标题
            if (stealthMode) {
                pageTitle.textContent = '项目文档 - 工作资料';
            } else {
                pageTitle.textContent = '马钱查看器 - Leeks';
            }
        }

        // 导出配置
        function exportStocks() {
            const data = JSON.stringify(stocks, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'leeks-stocks.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 导入配置
        function importStocks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            if (Array.isArray(imported)) {
                                stocks = imported;
                                saveStocks();
                                renderStocks();
                                refreshStocks();
                                alert('导入成功！');
                            }
                        } catch (error) {
                            alert('导入失败：文件格式错误');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            const editPopup = document.getElementById('editPopup');
            const isEditPopupOpen = editPopup.classList.contains('active');

            // ESC 关闭弹窗
            if (e.key === 'Escape') {
                closeChart();
                if (isEditPopupOpen) {
                    closeEditPopup();
                }
            }

            // 编辑弹窗中按 Enter 保存
            if (isEditPopupOpen && e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                saveEdit();
            }

            // Ctrl+R 刷新
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                refreshStocks();
            }

            // Ctrl+H 快速切换隐蔽模式（老板键）
            if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                toggleStealthMode();
                showToast(stealthMode ? '隐蔽模式已开启' : '隐蔽模式已关闭');
            }
        });

        // ==================== 云端同步功能 ====================

        // 打开云端同步弹窗
        function openCloudSync() {
            document.getElementById('cloudSyncPopup').style.display = 'flex';
            updateCloudSyncUI();
        }

        // 关闭云端同步弹窗
        function closeCloudSync(event) {
            if (!event || event.target.id === 'cloudSyncPopup') {
                document.getElementById('cloudSyncPopup').style.display = 'none';
            }
        }

        // 更新云端同步UI状态
        function updateCloudSyncUI() {
            const token = localStorage.getItem(GIST_TOKEN_KEY);
            const notConfigured = document.getElementById('notConfigured');
            const configured = document.getElementById('configured');

            if (token) {
                notConfigured.style.display = 'none';
                configured.style.display = 'block';
                document.getElementById('autoSyncCheckbox').checked = autoSyncEnabled;

                // 显示 GitHub Token
                document.getElementById('githubTokenDisplay').value = token;

                // 更新上次同步时间
                const lastSync = localStorage.getItem('leeks_last_sync');
                if (lastSync) {
                    const date = new Date(parseInt(lastSync));
                    document.getElementById('lastSyncTime').textContent = '上次同步: ' + date.toLocaleString();
                } else {
                    document.getElementById('lastSyncTime').textContent = '上次同步: --';
                }

                        // 显示 Gist 信息
                const gistId = localStorage.getItem(GIST_ID_KEY);
                const gistOwner = localStorage.getItem(GIST_OWNER_KEY);
                if (gistId) {
                    const gistUrl = gistOwner
                        ? `https://gist.github.com/${gistOwner}/${gistId}`
                        : `https://gist.github.com/${gistId}`;
                    document.getElementById('gistInfo').innerHTML = `
                        Gist ID: ${gistId}<br>
                        <a href="${gistUrl}" target="_blank">查看 Gist</a>
                    `;
                }
            } else {
                notConfigured.style.display = 'block';
                configured.style.display = 'none';
            }
        }

        // 保存 GitHub Token
        function saveGitHubToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                alert('请输入 GitHub Token');
                return;
            }
            localStorage.setItem(GIST_TOKEN_KEY, token);
            showToast('Token 保存成功！');
            updateCloudSyncUI();
        }

        // 复制 GitHub Token
        function copyGitHubToken() {
            const tokenInput = document.getElementById('githubTokenDisplay');
            const copyBtn = document.getElementById('copyTokenBtn');

            navigator.clipboard.writeText(tokenInput.value).then(() => {
                copyBtn.textContent = '已复制';
                setTimeout(() => {
                    copyBtn.textContent = '复制';
                }, 2000);
            }).catch(() => {
                // 降级方案
                tokenInput.select();
                document.execCommand('copy');
                copyBtn.textContent = '已复制';
                setTimeout(() => {
                    copyBtn.textContent = '复制';
                }, 2000);
            });
        }

        // 清除 GitHub Token
        function clearGitHubToken() {
            if (confirm('确定要清除云端同步配置吗？')) {
                localStorage.removeItem(GIST_TOKEN_KEY);
                localStorage.removeItem(GIST_ID_KEY);
                localStorage.removeItem(GIST_OWNER_KEY);
                localStorage.removeItem(AUTO_SYNC_KEY);
                autoSyncEnabled = false;
                showToast('配置已清除');
                updateCloudSyncUI();
            }
        }

        // 手动设置 Gist ID
        function setManualGistId() {
            const gistId = document.getElementById('manualGistId').value.trim();
            if (!gistId) {
                showToast('请输入 Gist ID');
                return;
            }
            localStorage.setItem(GIST_ID_KEY, gistId);
            showToast('Gist ID 已设置！');
            updateCloudSyncUI();
        }

        // 切换自动同步
        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncCheckbox').checked;
            localStorage.setItem(AUTO_SYNC_KEY, autoSyncEnabled);
            showToast(autoSyncEnabled ? '自动同步已开启' : '自动同步已关闭');
        }

        // 备份到 GitHub
        async function backupToGitHub(button) {
            const token = localStorage.getItem(GIST_TOKEN_KEY);
            if (!token) {
                showToast('请先配置 GitHub Token');
                return;
            }

            // 获取触发按钮元素
            const btn = button || (event && event.target);

            try {
                if (btn) btn.disabled = true;
                if (btn) btn.textContent = '备份中...';

                // 准备备份数据
                const backupData = {
                    version: '1.0',
                    timestamp: Date.now(),
                    stocks: stocks,
                    settings: {
                        autoRefreshEnabled: autoRefreshEnabled,
                        stealthMode: stealthMode,
                        sortColumn: sortColumn,
                        sortDirection: sortDirection,
                        visibleColumns: visibleColumns
                    }
                };

                const gistId = localStorage.getItem(GIST_ID_KEY);
                console.log('开始备份 - Token:', token ? '已配置' : '未配置', 'Gist ID:', gistId || '未找到');

                if (gistId && gistId !== '') {
                    // 更新现有 Gist
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            description: 'Leeks 股票配置备份',
                            files: {
                                'leeks-config.json': {
                                    content: JSON.stringify(backupData, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('更新 Gist 失败:', error);
                        throw new Error(error.message || '备份失败');
                    }

                    console.log('Gist 更新成功:', gistId);
                } else {
                    // 创建新 Gist
                    console.log('创建新 Gist');
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            description: 'Leeks 股票配置备份',
                            public: false,
                            files: {
                                'leeks-config.json': {
                                    content: JSON.stringify(backupData, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('创建 Gist 失败:', error);
                        throw new Error(error.message || '备份失败');
                    }

                    const result = await response.json();
                    console.log('创建 Gist 响应:', result);

                    const newGistId = result.id;

                    if (!newGistId) {
                        throw new Error('创建 Gist 失败，未返回 ID');
                    }

                    localStorage.setItem(GIST_ID_KEY, newGistId);

                    // 保存 owner 信息用于构建正确的 Gist 链接
                    if (result.owner && result.owner.login) {
                        localStorage.setItem(GIST_OWNER_KEY, result.owner.login);
                    }

                    console.log('Gist 创建成功:', newGistId);
                }

                // 更新同步时间
                localStorage.setItem('leeks_last_sync', Date.now().toString());

                showToast('备份成功！');
                updateCloudSyncUI();
            } catch (error) {
                console.error('备份失败:', error);
                showToast('备份失败: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '立即备份';
                }
            }
        }

        // 从 GitHub 恢复数据
        async function restoreFromGitHub(button) {
            const token = localStorage.getItem(GIST_TOKEN_KEY);
            const gistId = localStorage.getItem(GIST_ID_KEY);

            console.log('恢复数据 - Token:', token ? '已配置' : '未配置');
            console.log('恢复数据 - Gist ID:', gistId || '未找到');

            if (!token) {
                showToast('请先配置 GitHub Token');
                return;
            }

            if (!gistId) {
                showToast('未找到云端备份，请先点击"立即备份"创建备份');
                return;
            }

            if (!confirm('确定要从云端恢复数据吗？这将覆盖当前数据！')) {
                return;
            }

            // 获取触发按钮元素
            const btn = button || (event && event.target);

            try {
                if (btn) btn.disabled = true;
                if (btn) btn.textContent = '恢复中...';

                console.log('开始恢复数据，URL:', `https://api.github.com/gists/${gistId}`);

                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('获取 Gist 失败:', error);
                    throw new Error(error.message || '恢复失败');
                }

                const gist = await response.json();
                console.log('Gist 响应:', gist);

                const content = gist.files['leeks-config.json']?.content;

                if (!content) {
                    console.error('Gist 文件列表:', Object.keys(gist.files || {}));
                    throw new Error('Gist 中找不到配置文件');
                }

                const backupData = JSON.parse(content);
                console.log('解析备份数据:', backupData);

                // 恢复数据
                stocks = backupData.stocks || [];
                if (backupData.settings) {
                    autoRefreshEnabled = backupData.settings.autoRefreshEnabled ?? autoRefreshEnabled;
                    stealthMode = backupData.settings.stealthMode ?? stealthMode;
                    sortColumn = backupData.settings.sortColumn ?? sortColumn;
                    sortDirection = backupData.settings.sortDirection ?? sortDirection;
                    visibleColumns = backupData.settings.visibleColumns ?? visibleColumns;

                    // 保存设置到 localStorage
                    localStorage.setItem('leeks_auto_refresh', autoRefreshEnabled);
                    localStorage.setItem('leeks_stealth_mode', stealthMode);
                    localStorage.setItem('leeks_sort_column', sortColumn);
                    localStorage.setItem('leeks_sort_direction', sortDirection);
                    localStorage.setItem('leeks_visible_columns', JSON.stringify(visibleColumns));
                }

                saveStocks();
                renderStocks();
                applyStealthMode();
                updateAutoRefreshButton();

                showToast('恢复成功！已恢复 ' + stocks.length + ' 只股票');
            } catch (error) {
                console.error('恢复失败:', error);
                showToast('恢复失败: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '恢复数据';
                }
            }
        }

        // 显示提示信息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }

        // 列显示设置
        function openColumnSettings() {
            const content = document.getElementById('columnSettingsContent');
            content.innerHTML = columnConfig.map(col => `
                <div class="column-checkbox-item">
                    <input type="checkbox" id="col_${col.key}" ${visibleColumns.includes(col.key) ? 'checked' : ''}>
                    <label for="col_${col.key}">${col.name}</label>
                </div>
            `).join('');

            document.getElementById('columnSettingsPopup').classList.add('active');
        }

        function closeColumnSettings(event) {
            if (!event || event.target === document.getElementById('columnSettingsPopup')) {
                document.getElementById('columnSettingsPopup').classList.remove('active');
            }
        }

        function saveColumnSettings() {
            const checkboxes = document.querySelectorAll('#columnSettingsContent input[type="checkbox"]');
            visibleColumns = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    visibleColumns.push(cb.id.replace('col_', ''));
                }
            });

            // 至少保留编码和名称列
            if (!visibleColumns.includes('code')) visibleColumns.push('code');
            if (!visibleColumns.includes('name')) visibleColumns.push('name');

            localStorage.setItem('leeks_visible_columns', JSON.stringify(visibleColumns));
            renderStocks();
            closeColumnSettings();
            showToast('设置已保存');
        }

        function selectAllColumns() {
            document.querySelectorAll('#columnSettingsContent input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllColumns() {
            document.querySelectorAll('#columnSettingsContent input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // 语音播报相关功能
        function openVoiceSettings() {
            // 渲染股票列表
            const stockList = document.getElementById('voiceStockList');
            stockList.innerHTML = stocks.map(stock => `
                <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f5f5f5;">
                    <input type="checkbox" id="voice_${stock.code}" ${voiceBroadcastStocks.includes(stock.code) ? 'checked' : ''}
                           onchange="toggleVoiceStock('${stock.code}')" style="margin-right: 10px;">
                    <label for="voice_${stock.code}" style="flex: 1; cursor: pointer;">
                        <span style="font-weight: 600;">${stock.name}</span>
                        <span style="color: #999; margin-left: 8px; font-size: 12px;">${stock.code}</span>
                    </label>
                </div>
            `).join('');

            // 更新UI状态
            document.getElementById('voiceEnabledCheckbox').checked = voiceBroadcastEnabled;
            document.getElementById('voiceIntervalInput').value = voiceBroadcastInterval;

            document.getElementById('voiceSettingsPopup').classList.add('active');
        }

        function closeVoiceSettings(event) {
            if (!event || event.target === document.getElementById('voiceSettingsPopup')) {
                document.getElementById('voiceSettingsPopup').classList.remove('active');
            }
        }

        function toggleVoiceBroadcast() {
            voiceBroadcastEnabled = document.getElementById('voiceEnabledCheckbox').checked;
            localStorage.setItem('leeks_voice_broadcast', voiceBroadcastEnabled);

            if (voiceBroadcastEnabled) {
                startVoiceBroadcast();
                showToast('语音播报已开启');
            } else {
                stopVoiceBroadcast();
                showToast('语音播报已关闭');
            }
        }

        function toggleVoiceStock(code) {
            const index = voiceBroadcastStocks.indexOf(code);
            if (index > -1) {
                voiceBroadcastStocks.splice(index, 1);
            } else {
                voiceBroadcastStocks.push(code);
            }
            localStorage.setItem('leeks_voice_stocks', JSON.stringify(voiceBroadcastStocks));
        }

        function changeVoiceInterval(value) {
            let interval = parseInt(value);
            if (isNaN(interval) || interval < 1) interval = 1;
            if (interval > 300) interval = 300;
            voiceBroadcastInterval = interval;
            localStorage.setItem('leeks_voice_interval', interval);
            document.getElementById('voiceIntervalInput').value = interval;

            // 如果语音播报正在运行，重启以应用新间隔
            if (voiceBroadcastEnabled) {
                stopVoiceBroadcast();
                startVoiceBroadcast();
            }
        }

        function startVoiceBroadcast() {
            if (voiceBroadcastTimer) {
                clearInterval(voiceBroadcastTimer);
            }
            voiceBroadcastTimer = setInterval(broadcastVoice, voiceBroadcastInterval * 1000);
        }

        function stopVoiceBroadcast() {
            if (voiceBroadcastTimer) {
                clearInterval(voiceBroadcastTimer);
                voiceBroadcastTimer = null;
            }
        }

        function updateVoiceUI() {
            // 初始化时启动语音播报（如果已开启）
            if (voiceBroadcastEnabled) {
                startVoiceBroadcast();
            }
        }

        function broadcastVoice() {
            if (!voiceBroadcastEnabled || voiceBroadcastStocks.length === 0) {
                return;
            }

            // 检查股市是否收盘
            if (!isMarketOpen()) {
                return;
            }

            // 获取需要播报的股票数据
            const voiceStocks = stocks.filter(stock => voiceBroadcastStocks.includes(stock.code));

            if (voiceStocks.length === 0) {
                return;
            }

            // 构建播报文本
            const messages = voiceStocks.map(stock => {
                const changePercent = parseFloat(stock.changePercent) || 0;
                const now = stock.now || '--';
                const name = stock.name || stock.code;

                if (changePercent > 0) {
                    return `${name}当前价${now}，上涨${changePercent.toFixed(2)}%`;
                } else if (changePercent < 0) {
                    return `${name}当前价${now}，下跌${Math.abs(changePercent).toFixed(2)}%`;
                } else {
                    return `${name}当前价${now}，平盘`;
                }
            });

            // 播报所有消息
            const speechText = messages.join('，') + '。';
            speak(speechText);
        }

        // 判断股市是否开盘
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();

            // 周末休市（周六=6，周日=0）
            if (day === 0 || day === 6) {
                return false;
            }

            const hours = now.getHours();
            const minutes = now.getMinutes();
            const currentTime = hours * 60 + minutes;

            // A股交易时间：
            // 上午：9:30-11:30
            // 下午：13:00-15:00
            const morningOpen = 9 * 60 + 30;   // 9:30
            const morningClose = 11 * 60 + 30; // 11:30
            const afternoonOpen = 13 * 60;      // 13:00
            const afternoonClose = 15 * 60;     // 15:00

            // 检查是否在交易时间内
            if ((currentTime >= morningOpen && currentTime <= morningClose) ||
                (currentTime >= afternoonOpen && currentTime <= afternoonClose)) {
                return true;
            }

            return false;
        }

        function speak(text) {
            // 取消之前的语音
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }

            // 创建语音
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            // 尝试使用中文语音
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                const chineseVoice = voices.find(voice =>
                    voice.lang.includes('zh') || voice.lang.includes('CN')
                );
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                }

                window.speechSynthesis.speak(utterance);
            }
        }

        function testVoiceBroadcast() {
            if (voiceBroadcastStocks.length === 0) {
                showToast('请先选择要播报的股票');
                return;
            }

            broadcastVoice();
        }
    </script>
</body>
</html>
