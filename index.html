<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">è‚¡ç¥¨è¡Œæƒ…æŸ¥çœ‹å™¨ - Leeks</title>
    <meta name="description" content="ç®€æ´å®ç”¨çš„è‚¡ç¥¨è¡Œæƒ…æŸ¥çœ‹å·¥å…·ï¼Œæ”¯æŒAè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡å®æ—¶è¡Œæƒ…ï¼Œæˆæœ¬ä»·ç®¡ç†ï¼Œç›®æ ‡ä»·æ­¢æŸè®¾ç½®">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .refresh-info {
            color: #7f8c8d;
            font-size: 12px;
            margin-left: 15px;
        }

        .stock-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stock-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .stock-input input:focus {
            outline: none;
            border-color: #3498db;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: #219a52;
        }

        .help-text {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 8px;
        }

        .stock-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .stock-list {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stock-table th {
            background: #34495e;
            color: white;
            padding: 10px 10px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        .stock-table th:hover {
            background: #2c3e50;
        }

        .stock-table th::after {
            content: 'â†•';
            margin-left: 3px;
            opacity: 0.3;
        }

        .stock-table th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
        }

        .stock-table th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
        }

        .stock-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            white-space: nowrap;
        }

        .stock-table tr:hover {
            background: #f8f9fa;
        }

        .stock-table tr:hover td {
            cursor: pointer;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 0 10px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 18px;
            }

            .stock-input {
                flex-direction: column;
            }

            .stock-input input {
                width: 100%;
            }

            .toolbar {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .toolbar-left,
            .toolbar-right {
                flex-wrap: wrap;
                justify-content: center;
            }

            .stock-table th {
                padding: 8px 6px;
                font-size: 10px;
            }

            .stock-table td {
                padding: 6px 6px;
                font-size: 11px;
            }

            .price-status {
                min-width: 60px;
                font-size: 10px;
                padding: 1px 6px;
            }

            .chart-container {
                max-width: 95vw;
                margin: 10px;
            }

            .chart-content img {
                max-height: 40vh;
            }

            .shortcut-hint {
                display: none;
            }
        }

        /* è¶…å°å±å¹• */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }

            .refresh-btn,
            .add-btn,
            .toolbar-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .stock-table th,
            .stock-table td {
                padding: 5px 4px;
                font-size: 10px;
            }
        }

        /* åˆ—è®¾ç½®å¼¹çª— */
        .column-settings-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .column-settings-popup.active {
            display: flex;
        }

        .column-settings-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .column-settings-content {
            overflow-y: auto;
            max-height: 60vh;
            padding: 10px 0;
        }

        .column-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .column-checkbox-item:last-child {
            border-bottom: none;
        }

        .column-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }

        .column-checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .column-settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .column-settings-buttons .toolbar-btn {
            flex: 1;
        }

        /* æ¶¨è·Œé¢œè‰² */
        .red {
            color: #e74c3c;
        }

        .green {
            color: #27ae60;
        }

        .gray {
            color: #95a5a6;
        }

        /* éšè”½æ¨¡å¼ */
        body.stealth-mode {
            background: #fafafa;
        }

        body.stealth-mode .header h1 {
            color: #bdc3c7;
        }

        body.stealth-mode .header,
        body.stealth-mode .stock-input,
        body.stealth-mode .toolbar {
            background: #f5f5f5;
            box-shadow: none;
            border: 1px solid #e0e0e0;
        }

        body.stealth-mode .stock-table {
            background: #fafafa;
        }

        body.stealth-mode .stock-table th {
            background: #ecf0f1;
            color: #95a5a6;
        }

        body.stealth-mode .stock-table tr:hover {
            background: transparent;
        }

        body.stealth-mode .stock-table td {
            color: #7f8c8d;
        }

        body.stealth-mode .red,
        body.stealth-mode .green {
            color: #7f8c8d !important;
        }

        body.stealth-mode .refresh-btn {
            background: #95a5a6;
        }

        body.stealth-mode .refresh-btn:hover {
            background: #7f8c8d;
        }

        body.stealth-mode .add-btn {
            background: #95a5a6;
        }

        body.stealth-mode .add-btn:hover {
            background: #7f8c8d;
        }

        body.stealth-mode .auto-refresh-indicator {
            background: #95a5a6;
            animation: none;
        }

        body.stealth-mode .refresh-info {
            color: #bdc3c7;
        }

        body.stealth-mode .toolbar-btn {
            border-color: #e0e0e0;
            color: #95a5a6;
        }

        body.stealth-mode .toolbar-btn:hover {
            background: #ecf0f1;
        }

        body.stealth-mode .delete-btn {
            color: #95a5a6 !important;
            border-color: #e0e0e0 !important;
        }

        body.stealth-mode .delete-btn:hover {
            background: #ecf0f1 !important;
            color: #95a5a6 !important;
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: #f5f5f5;
        }

        .toolbar-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .delete-btn {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* å›¾è¡¨å¼¹çª— */
        .chart-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chart-popup.active {
            display: flex;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .chart-container.edit-container {
            max-width: 400px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        /* ç¼–è¾‘è¡¨å• */
        .edit-form {
            padding: 10px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group input[readonly] {
            background: #f5f5f5;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .form-buttons .toolbar-btn {
            flex: 1;
            text-align: center;
        }

        /* å¯ç¼–è¾‘å•å…ƒæ ¼ */
        .editable {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s;
        }

        .editable:hover {
            color: #2980b9;
            text-decoration: none;
        }

        body.stealth-mode .editable {
            color: #7f8c8d;
        }

        body.stealth-mode .editable:hover {
            color: #95a5a6;
        }

        .chart-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .chart-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .chart-tab:hover {
            background: #f5f5f5;
        }

        .chart-tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 500;
        }

        .chart-content {
            display: none;
        }

        .chart-content.active {
            display: block;
        }

        .chart-content img {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .chart-error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        /* å³é”®èœå• */
        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            z-index: 1001;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #3498db;
            color: white;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* ä»·æ ¼çŠ¶æ€æ ‡ç­¾ */
        .price-status {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .price-status.target {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .price-status.stop {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .price-status.neutral {
            background: transparent;
            color: #7f8c8d;
        }

        /* æ‚¬åœæç¤º */
        .price-tooltip {
            position: relative;
            cursor: help;
        }

        .price-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            margin-bottom: 8px;
            pointer-events: none;
        }

        .price-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .price-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            margin-bottom: -4px;
            pointer-events: none;
        }

        .price-tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* å¿«æ·é”®æç¤º */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #7f8c8d;
            border: 1px solid #3498db;
        }

        body.stealth-mode .shortcut-hint {
            display: none;
        }

        .shortcut-hint kbd {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ddd;
            font-family: monospace;
            margin: 0 2px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        /* è‡ªåŠ¨åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .auto-refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .auto-refresh-indicator.paused {
            background: #e74c3c;
            animation: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è‚¡ç¥¨è¡Œæƒ…æŸ¥çœ‹å™¨</h1>
            <div>
                <button class="refresh-btn" onclick="refreshStocks()">
                    <span class="auto-refresh-indicator" id="autoRefreshIndicator"></span>
                    åˆ·æ–°æ•°æ®
                </button>
                <span class="refresh-info" id="refreshInfo">æœ€ååˆ·æ–°: --</span>
            </div>
        </div>

        <div class="stock-input">
            <input type="text" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¦‚: sh600519, sz000001ï¼ˆæ”¯æŒ Aè‚¡ã€æ¸¯è‚¡ hkã€ç¾è‚¡ usï¼Œä¸æ”¯æŒæŒ‡æ•°ï¼‰"
                   onkeypress="if(event.key==='Enter') addStock()">
            <button class="add-btn" onclick="addStock()">æ·»åŠ </button>
            <div style="flex: 1"></div>
            <button class="toolbar-btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">åˆ·æ–°: å¼€</button>
            <button class="toolbar-btn" onclick="toggleStealthMode()" id="stealthModeBtn">éšè”½</button>
        </div>

        <div class="toolbar">
            <div class="toolbar-left">
                <button class="toolbar-btn" onclick="clearAllStocks()" style="color: #e74c3c;">æ¸…ç©º</button>
                <button class="toolbar-btn" onclick="exportStocks()">å¯¼å‡º</button>
                <button class="toolbar-btn" onclick="importStocks()">å¯¼å…¥</button>
                <button class="toolbar-btn" onclick="openColumnSettings()">åˆ—è®¾ç½®</button>
            </div>
            <div class="toolbar-right">
                <span style="font-size: 12px; color: #7f8c8d;">åˆ·æ–°: <span id="refreshInterval">10</span>s</span>
            </div>
        </div>

        <div class="stock-list">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('code')">ç¼–ç </th>
                        <th onclick="sortTable('name')">è‚¡ç¥¨åç§°</th>
                        <th onclick="sortTable('now')">å½“å‰ä»·</th>
                        <th onclick="sortTable('change')">æ¶¨è·Œ</th>
                        <th onclick="sortTable('changePercent')">æ¶¨è·Œå¹…</th>
                        <th onclick="sortTable('time')">æ›´æ–°æ—¶é—´</th>
                        <th onclick="sortTable('max')">æœ€é«˜ä»·</th>
                        <th onclick="sortTable('min')">æœ€ä½ä»·</th>
                        <th>æˆæœ¬ä»·</th>
                        <th>æŒä»“</th>
                        <th>æ”¶ç›Šç‡</th>
                        <th>æ”¶ç›Š</th>
                        <th onclick="sortTable('targetPrice')">ç›®æ ‡ä»·</th>
                        <th onclick="sortTable('stopLoss')">æ­¢æŸä»·</th>
                        <th>çŠ¶æ€</th>
                        <th onclick="sortTable('yieldToTarget')">ç›®æ ‡æ”¶ç›Š</th>
                        <th onclick="sortTable('yieldToStop')">æ­¢æŸæŸå¤±</th>
                        <th onclick="sortTable('riskRewardRatio')">ç›ˆäºæ¯”</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    <!-- è‚¡ç¥¨æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
                </tbody>
            </table>
        </div>

        <!-- ç¼–è¾‘å¼¹çª— -->
        <div class="chart-popup" id="editPopup" onclick="closeEditPopup(event)">
            <div class="chart-container" onclick="event.stopPropagation()">
                <div class="chart-header">
                    <span class="chart-title" id="editTitle">ç¼–è¾‘è‚¡ç¥¨</span>
                    <button class="close-btn" onclick="closeEditPopup()">Ã—</button>
                </div>
                <div class="edit-form">
                    <div class="form-group">
                        <label>è‚¡ç¥¨ä»£ç </label>
                        <input type="text" id="editCode" readonly>
                    </div>
                    <div class="form-group">
                        <label>è‚¡ç¥¨åç§°</label>
                        <input type="text" id="editName" readonly>
                    </div>
                    <div class="form-group">
                        <label>æˆæœ¬ä»·</label>
                        <input type="number" id="editCost" placeholder="è¾“å…¥æˆæœ¬ä»·ï¼Œå¦‚: 1000">
                    </div>
                    <div class="form-group">
                        <label>æŒä»“æ•°é‡</label>
                        <input type="number" id="editBonds" placeholder="è¾“å…¥æŒä»“æ•°é‡ï¼Œå¦‚: 100">
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡ä»·</label>
                        <input type="number" id="editTargetPrice" placeholder="è¾“å…¥ç›®æ ‡ä»·ï¼Œå¦‚: 1200" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>æ­¢æŸä»·</label>
                        <input type="number" id="editStopLoss" placeholder="è¾“å…¥æ­¢æŸä»·ï¼Œå¦‚: 900" step="0.01">
                    </div>
                    <div class="form-buttons">
                        <button class="toolbar-btn" onclick="closeEditPopup()">å–æ¶ˆ</button>
                        <button class="toolbar-btn active" onclick="saveEdit()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·é”®æç¤º -->
        <div class="shortcut-hint" id="shortcutHint">
            <div><kbd>Ctrl</kbd> + <kbd>H</kbd> å¿«é€Ÿåˆ‡æ¢éšè”½æ¨¡å¼</div>
            <div style="margin-top: 5px;"><kbd>Ctrl</kbd> + <kbd>R</kbd> åˆ·æ–°æ•°æ®</div>
            <div style="margin-top: 5px;"><kbd>ESC</kbd> å…³é—­å¼¹çª—</div>
        </div>
    </div>

    <!-- å›¾è¡¨å¼¹çª— -->
    <div class="chart-popup" id="chartPopup" onclick="closeChart(event)">
        <div class="chart-container" onclick="event.stopPropagation()">
            <div class="chart-header">
                <span class="chart-title" id="chartTitle">è‚¡ç¥¨å›¾è¡¨</span>
                <button class="close-btn" onclick="closeChart()">Ã—</button>
            </div>
            <div class="chart-tabs">
                <div class="chart-tab active" data-type="min">åˆ†æ—¶å›¾</div>
                <div class="chart-tab" data-type="daily">æ—¥Kçº¿</div>
                <div class="chart-tab" data-type="weekly">å‘¨Kçº¿</div>
                <div class="chart-tab" data-type="monthly">æœˆKçº¿</div>
            </div>
            <div class="chart-content active" id="chartContent">
                <img id="chartImage" src="" alt="è‚¡ç¥¨å›¾è¡¨">
            </div>
        </div>
    </div>

        <!-- å³é”®èœå• -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" data-type="min">åˆ†æ—¶å›¾</div>
            <div class="context-menu-item" data-type="daily">æ—¥Kçº¿</div>
            <div class="context-menu-item" data-type="weekly">å‘¨Kçº¿</div>
            <div class="context-menu-item" data-type="monthly">æœˆKçº¿</div>
        </div>

        <!-- åˆ—è®¾ç½®å¼¹çª— -->
        <div class="column-settings-popup" id="columnSettingsPopup" onclick="closeColumnSettings(event)">
            <div class="column-settings-container" onclick="event.stopPropagation()">
                <div class="chart-header">
                    <span class="chart-title">åˆ—æ˜¾ç¤ºè®¾ç½®</span>
                    <button class="close-btn" onclick="closeColumnSettings()">Ã—</button>
                </div>
                <div class="column-settings-content" id="columnSettingsContent">
                    <!-- åˆ—é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="column-settings-buttons">
                    <button class="toolbar-btn" onclick="selectAllColumns()">å…¨é€‰</button>
                    <button class="toolbar-btn" onclick="deselectAllColumns()">å…¨ä¸é€‰</button>
                    <button class="toolbar-btn active" onclick="saveColumnSettings()">ç¡®å®š</button>
                </div>
            </div>
        </div>

    <script>
        // è‚¡ç¥¨æ•°æ®å­˜å‚¨
        let stocks = JSON.parse(localStorage.getItem('leeks_stocks') || '[]');
        let autoRefreshEnabled = localStorage.getItem('leeks_auto_refresh') !== 'false';
        let stealthMode = localStorage.getItem('leeks_stealth_mode') === 'true';
        let sortColumn = localStorage.getItem('leeks_sort_column') || 'code';
        let sortDirection = localStorage.getItem('leeks_sort_direction') || 'asc';
        let refreshTimer = null;
        let currentChartStock = null;

        // åˆ—é…ç½®
        const columnConfig = [
            { key: 'code', name: 'ç¼–ç ', default: true },
            { key: 'name', name: 'è‚¡ç¥¨åç§°', default: true },
            { key: 'now', name: 'å½“å‰ä»·', default: true },
            { key: 'change', name: 'æ¶¨è·Œ', default: true },
            { key: 'changePercent', name: 'æ¶¨è·Œå¹…', default: true },
            { key: 'time', name: 'æ›´æ–°æ—¶é—´', default: false },
            { key: 'max', name: 'æœ€é«˜ä»·', default: false },
            { key: 'min', name: 'æœ€ä½ä»·', default: false },
            { key: 'cost', name: 'æˆæœ¬ä»·', default: true },
            { key: 'bonds', name: 'æŒä»“', default: true },
            { key: 'incomePercent', name: 'æ”¶ç›Šç‡', default: true },
            { key: 'income', name: 'æ”¶ç›Š', default: true },
            { key: 'targetPrice', name: 'ç›®æ ‡ä»·', default: true },
            { key: 'stopLoss', name: 'æ­¢æŸä»·', default: true },
            { key: 'status', name: 'çŠ¶æ€', default: true },
            { key: 'yieldToTarget', name: 'ç›®æ ‡æ”¶ç›Š', default: true },
            { key: 'yieldToStop', name: 'æ­¢æŸæŸå¤±', default: true },
            { key: 'riskRewardRatio', name: 'ç›ˆäºæ¯”', default: true }
        ];

        let visibleColumns = JSON.parse(localStorage.getItem('leeks_visible_columns') || JSON.stringify(columnConfig.map(c => c.key)));

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            if (stocks.length === 0) {
                // æ·»åŠ é»˜è®¤ç¤ºä¾‹è‚¡ç¥¨
                stocks = [
                    { code: 'sh600519', name: 'è´µå·èŒ…å°', cost: '1000', bonds: '100', targetPrice: '1200', stopLoss: '950' },
                    { code: 'sz000001', name: 'å¹³å®‰é“¶è¡Œ', cost: '10', bonds: '1000', targetPrice: '12', stopLoss: '9' },
                    { code: 'sz000002', name: 'ä¸‡ç§‘A', cost: '20', bonds: '500', targetPrice: '25', stopLoss: '18' }
                ];
                saveStocks();
            }

            applyStealthMode();
            updateAutoRefreshButton();
            renderStocks();
            refreshStocks();

            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();

            // ç»‘å®šå›¾è¡¨ Tab ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    loadChart(currentChartStock, tab.dataset.type);
                });
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å³é”®èœå•
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.remove('active');
            });

            // å³é”®èœå•é¡¹ç‚¹å‡»
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (currentChartStock) {
                        showChart(currentChartStock, item.dataset.type);
                    }
                });
            });
        });

        // ä¿å­˜è‚¡ç¥¨åˆ—è¡¨åˆ° localStorage
        function saveStocks() {
            localStorage.setItem('leeks_stocks', JSON.stringify(stocks));
        }

        // æ¸²æŸ“è‚¡ç¥¨è¡¨æ ¼
        function renderStocks() {
            const tbody = document.getElementById('stockTableBody');
            const thead = document.querySelector('.stock-table thead tr');

            if (stocks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${visibleColumns.length + 1}" class="empty-state">
                            <div class="empty-state-icon">ğŸ“ˆ</div>
                            <div class="empty-state-text">æš‚æ— è‚¡ç¥¨ï¼Œè¯·æ·»åŠ è‚¡ç¥¨ä»£ç </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // æ¸²æŸ“è¡¨å¤´
            thead.innerHTML = renderTableHeader();

            // æ’åº
            stocks.sort((a, b) => {
                let valA = a[sortColumn] || '';
                let valB = b[sortColumn] || '';

                // ç›ˆäºæ¯”ç‰¹æ®Šå¤„ç†ï¼ˆä» "2.5:1" ä¸­æå–æ•°å­—ï¼‰
                if (sortColumn === 'riskRewardRatio') {
                    valA = valA !== '--' ? parseFloat(valA.split(':')[0]) || 0 : 0;
                    valB = valB !== '--' ? parseFloat(valB.split(':')[0]) || 0 : 0;
                }

                // æ•°å€¼å­—æ®µè½¬æ¢ä¸ºæ•°å­—æ¯”è¾ƒ
                if (['now', 'change', 'changePercent', 'max', 'min', 'cost', 'bonds', 'incomePercent', 'income', 'targetPrice', 'stopLoss', 'yieldToTarget', 'yieldToStop', 'riskRewardRatio'].includes(sortColumn)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }

                if (sortDirection === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });

            // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.stock-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(sortColumn)) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            tbody.innerHTML = stocks.map(stock => {
                return `<tr data-code="${stock.code}" ondblclick="showChart('${stock.code}', 'min')" oncontextmenu="showContextMenu(event, '${stock.code}')">${renderTableCells(stock)}</tr>`;
            }).join('');
        }

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeader() {
            return columnConfig
                .filter(col => visibleColumns.includes(col.key))
                .map(col => {
                    if (col.key === 'status') {
                        return `<th>çŠ¶æ€</th>`;
                    }
                    return `<th onclick="sortTable('${col.key}')">${col.name}</th>`;
                })
                .join('') + '<th>æ“ä½œ</th>';
        }

        // æ¸²æŸ“è¡¨æ ¼å•å…ƒæ ¼
        function renderTableCells(stock) {
            // è®¡ç®—ä»·æ ¼çŠ¶æ€
            const now = parseFloat(stock.now);
            const targetPrice = parseFloat(stock.targetPrice);
            const stopLoss = parseFloat(stock.stopLoss);
            let priceStatus = 'neutral';
            let statusText = '--';

            // è®¡ç®—ç›®æ ‡ä»·è·ç¦»ç™¾åˆ†æ¯”
            let targetPercent = '--';
            if (!isNaN(now) && !isNaN(targetPrice) && targetPrice > 0 && now > 0) {
                targetPercent = ((targetPrice - now) / now * 100).toFixed(2);
            }

            // è®¡ç®—æ­¢æŸä»·è·ç¦»ç™¾åˆ†æ¯”
            let stopLossPercent = '--';
            if (!isNaN(now) && !isNaN(stopLoss) && stopLoss > 0 && now > 0) {
                stopLossPercent = ((stopLoss - now) / now * 100).toFixed(2);
            }

            // è®¡ç®—ç›®æ ‡æ”¶ç›Šæ¯”ï¼ˆç›®æ ‡ä»·ç›¸å¯¹æˆæœ¬ä»·çš„æ”¶ç›Šç‡ï¼‰
            let yieldToTarget = '--';
            if (!isNaN(targetPrice) && stock.cost && stock.cost !== '--') {
                const cost = parseFloat(stock.cost);
                if (cost > 0) {
                    yieldToTarget = ((targetPrice - cost) / cost * 100).toFixed(2);
                }
            }

            // è®¡ç®—æ­¢æŸæŸå¤±æ¯”ï¼ˆæ­¢æŸä»·ç›¸å¯¹æˆæœ¬ä»·çš„æ”¶ç›Šç‡ï¼‰
            let yieldToStop = '--';
            if (!isNaN(stopLoss) && stock.cost && stock.cost !== '--') {
                const cost = parseFloat(stock.cost);
                if (cost > 0) {
                    yieldToStop = ((stopLoss - cost) / cost * 100).toFixed(2);
                }
            }

            // è®¡ç®—ç›ˆäºæ¯” = ç›®æ ‡æ”¶ç›Šç»å¯¹å€¼ / æ­¢æŸæŸå¤±ç»å¯¹å€¼
            let riskRewardRatio = '--';
            if (yieldToTarget !== '--' && yieldToStop !== '--') {
                const targetYield = parseFloat(yieldToTarget);
                const stopLossYield = parseFloat(yieldToStop);
                if (targetYield > 0 && stopLossYield < 0) {
                    riskRewardRatio = (targetYield / Math.abs(stopLossYield)).toFixed(2) + ':1';
                }
            }

            if (!isNaN(now) && !isNaN(targetPrice) && targetPrice > 0) {
                if (now >= targetPrice) {
                    priceStatus = 'target';
                    statusText = 'å·²è¾¾ç›®æ ‡';
                }
            }
            if (!isNaN(now) && !isNaN(stopLoss) && stopLoss > 0) {
                if (now <= stopLoss) {
                    priceStatus = 'stop';
                    statusText = 'å·²è§¦å‘æ­¢æŸ';
                }
            }
            if (priceStatus === 'neutral' && (!isNaN(targetPrice) || !isNaN(stopLoss))) {
                statusText = 'æŒæœ‰ä¸­';
            }

            // å•å…ƒæ ¼æ˜ å°„
            const cellMap = {
                code: `<td>${stock.code}</td>`,
                name: `<td>${stealthMode ? toPinyin(stock.name) : stock.name}</td>`,
                now: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${stock.now || '--'}</td>`,
                change: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${formatChange(stock.change)}</td>`,
                changePercent: `<td class="${stock.changePercent >= 0 ? 'red' : stock.changePercent < 0 ? 'green' : 'gray'}">${formatChangePercent(stock.changePercent)}</td>`,
                time: `<td>${formatTime(stock.time)}</td>`,
                max: `<td>${stock.max || '--'}</td>`,
                min: `<td>${stock.min || '--'}</td>`,
                cost: `<td class="editable" onclick="event.stopPropagation(); openEditPopup('${stock.code}')">${stock.cost || '--'}</td>`,
                bonds: `<td class="editable" onclick="event.stopPropagation(); openEditPopup('${stock.code}')">${stock.bonds || '--'}</td>`,
                incomePercent: `<td class="${stock.incomePercent >= 0 ? 'red' : stock.incomePercent < 0 ? 'green' : 'gray'}">${formatChangePercent(stock.incomePercent)}</td>`,
                income: `<td class="${stock.income >= 0 ? 'red' : stock.income < 0 ? 'green' : 'gray'}">${formatIncome(stock.income)}</td>`,
                targetPrice: `<td class="editable price-tooltip" onclick="event.stopPropagation(); openEditPopup('${stock.code}')"
                    data-tooltip="è·ç¦»å½“å‰ä»·: ${targetPercent !== '--' ? (targetPercent > 0 ? '+' : '') + targetPercent + '%' : '--'}">${stock.targetPrice || '--'}</td>`,
                stopLoss: `<td class="editable price-tooltip" onclick="event.stopPropagation(); openEditPopup('${stock.code}')"
                    data-tooltip="è·ç¦»å½“å‰ä»·: ${stopLossPercent !== '--' ? (stopLossPercent > 0 ? '+' : '') + stopLossPercent + '%' : '--'}">${stock.stopLoss || '--'}</td>`,
                status: `<td><span class="price-status ${priceStatus}">${statusText}</span></td>`,
                yieldToTarget: `<td class="${yieldToTarget >= 0 ? 'red' : yieldToTarget < 0 ? 'green' : 'gray'}">${formatChangePercent(yieldToTarget)}</td>`,
                yieldToStop: `<td class="${yieldToStop >= 0 ? 'red' : yieldToStop < 0 ? 'green' : 'gray'}">${formatChangePercent(yieldToStop)}</td>`,
                riskRewardRatio: `<td class="price-tooltip" data-tooltip="${riskRewardRatio !== '--' ? 'æ”¶ç›Šæ½œåŠ›æ˜¯é£é™©çš„ ' + riskRewardRatio.split(':')[0] + ' å€' : '--'}">${riskRewardRatio}</td>`
            };

            return columnConfig
                .filter(col => visibleColumns.includes(col.key))
                .map(col => cellMap[col.key] || '')
                .join('') + '<td><button class="toolbar-btn delete-btn" onclick="deleteStock(\'' + stock.code + '\', event)">åˆ é™¤</button></td>';
        }

        // æ ¼å¼åŒ–æ¶¨è·Œ
        function formatChange(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}` : value.toFixed(2);
        }

        // æ ¼å¼åŒ–æ¶¨è·Œå¹…
        function formatChangePercent(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}%` : `${value.toFixed(2)}%`;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(time) {
            if (!time) return '--';
            return time.substring(8);
        }

        // æ ¼å¼åŒ–æ”¶ç›Š
        function formatIncome(value) {
            if (!value) return '--';
            value = parseFloat(value);
            return value >= 0 ? `+${value.toFixed(2)}` : value.toFixed(2);
        }

        // æ‹¼éŸ³è½¬æ¢ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function toPinyin(text) {
            // ç®€åŒ–å®ç°ï¼šå®é™…åº”è¯¥ä½¿ç”¨æ‹¼éŸ³åº“
            const pinyinMap = {
                'è´µå·èŒ…å°': 'Guizhou Maotai',
                'å¹³å®‰é“¶è¡Œ': 'Ping An Bank',
                'ä¸‡ç§‘A': 'Vanke A',
                'è‹±å¨è…¾': 'Invt'
            };
            return pinyinMap[text] || text;
        }

        // æ·»åŠ è‚¡ç¥¨
        function addStock() {
            const input = document.getElementById('stockInput');
            const value = input.value.trim();

            if (!value) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            // è§£æè¾“å…¥ï¼ˆæ”¯æŒæ ¼å¼: code æˆ– code,cost,bondsï¼‰
            const parts = value.split(',').map(s => s.trim());
            const code = parts[0];
            const cost = parts[1] || '--';
            const bonds = parts[2] || '--';

            // éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
            const prefix = code.substring(0, 2).toLowerCase();
            if (!['sh', 'sz', 'hk', 'us'].includes(prefix)) {
                alert('è‚¡ç¥¨ä»£ç æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨: sh600519, sz000001, hk00700, usAAPL');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (stocks.find(s => s.code === code)) {
                alert('è¯¥è‚¡ç¥¨å·²å­˜åœ¨');
                return;
            }

            stocks.push({
                code,
                name: '--',
                cost,
                bonds,
                now: '--',
                change: '--',
                changePercent: '--',
                time: '--',
                max: '--',
                min: '--',
                incomePercent: '--',
                income: '--',
                targetPrice: '--',
                stopLoss: '--'
            });

            saveStocks();
            renderStocks();
            refreshStocks();

            input.value = '';
        }

        // åˆ é™¤è‚¡ç¥¨
        function deleteStock(code, event) {
            event.stopPropagation();
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${code} å—ï¼Ÿ`)) {
                stocks = stocks.filter(s => s.code !== code);
                saveStocks();
                renderStocks();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è‚¡ç¥¨
        function clearAllStocks() {
            if (stocks.length === 0) {
                alert('è‚¡ç¥¨åˆ—è¡¨å·²ä¸ºç©º');
                return;
            }
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‚¡ç¥¨å—ï¼Ÿ')) {
                stocks = [];
                saveStocks();
                renderStocks();
            }
        }

        // åˆ·æ–°è‚¡ç¥¨æ•°æ®
        async function refreshStocks() {
            if (stocks.length === 0) return;

            const codes = stocks.map(s => s.code.split(',')[0]).join(',');
            if (!codes) return;

            try {
                const response = await fetch(`https://qt.gtimg.cn/q=${codes}`);
                const arrayBuffer = await response.arrayBuffer();
                const decoder = new TextDecoder('GBK');
                const text = decoder.decode(arrayBuffer);
                parseStockData(text);
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            }

            // æ›´æ–°åˆ·æ–°æ—¶é—´
            const now = new Date();
            document.getElementById('refreshInfo').textContent = `æœ€ååˆ·æ–°: ${now.toLocaleTimeString()}`;
        }

        // è§£æè‚¡ç¥¨æ•°æ®
        function parseStockData(text) {
            const lines = text.split('\n');

            lines.forEach(line => {
                if (!line.includes('~')) return;

                // æ”¯æŒæ™®é€šè‚¡ç¥¨å’ŒæŒ‡æ•°ï¼ˆå¦‚ sh000001, sz399001ï¼‰
                const codeMatch = line.match(/v_([a-z]{2}\d{4,6})/);
                if (!codeMatch) return;

                const code = codeMatch[1];
                const values = line.split('~');

                const stock = stocks.find(s => s.code === code);
                if (stock) {
                    stock.name = values[1] || '--';
                    stock.now = values[3] || '--';
                    stock.change = values[31] || '--';
                    stock.changePercent = values[32] || '--';
                    stock.time = values[30] || '--';
                    stock.max = values[33] || '--';
                    stock.min = values[34] || '--';

                    // è®¡ç®—æ”¶ç›Š
                    if (stock.cost && stock.cost !== '--' && parseFloat(stock.cost) > 0) {
                        const cost = parseFloat(stock.cost);
                        const now = parseFloat(stock.now);
                        if (!isNaN(now)) {
                            const income = (now - cost);
                            stock.incomePercent = ((income / cost) * 100).toFixed(2);

                            if (stock.bonds && stock.bonds !== '--') {
                                const bonds = parseFloat(stock.bonds);
                                stock.income = (income * bonds).toFixed(2);
                            }
                        }
                    }
                }
            });

            saveStocks();
            renderStocks();
        }

        // æ’åºè¡¨æ ¼
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            localStorage.setItem('leeks_sort_column', sortColumn);
            localStorage.setItem('leeks_sort_direction', sortDirection);

            renderStocks();
        }

        // æ˜¾ç¤ºå›¾è¡¨
        function showChart(code, type) {
            currentChartStock = code;
            const prefix = code.substring(0, 2).toLowerCase();
            const stock = stocks.find(s => s.code === code);
            const name = stock ? stock.name : code;

            document.getElementById('chartTitle').textContent = `${name} (${code})`;

            // æ›´æ–° Tab çŠ¶æ€
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });

            loadChart(code, type);
            document.getElementById('chartPopup').classList.add('active');
        }

        // åŠ è½½å›¾è¡¨
        function loadChart(code, type) {
            const prefix = code.substring(0, 2).toLowerCase();
            const timestamp = Date.now();
            let url = '';

            // æŒ‡æ•°ä¸æ”¯æŒå›¾è¡¨ï¼ˆå¦‚ sh000001, sz399001ï¼‰
            if (code === 'sh000001' || code === 'sz399001' || code === 'sh000300') {
                showChartError('è¯¥æŒ‡æ•°æš‚ä¸æ”¯æŒå›¾è¡¨å±•ç¤º');
                return;
            }

            if (prefix === 'sh' || prefix === 'sz') {
                url = `https://image.sinajs.cn/newchart/${type}/n/${code}.gif?${timestamp}`;
            } else if (prefix === 'us') {
                if (type === 'min') {
                    url = `https://image.sinajs.cn/newchart/png/${type}/${prefix}/${code.substring(2)}.png?${timestamp}`;
                } else {
                    url = `https://image.sinajs.cn/newchart/${prefix}stock/${type}/${code.substring(2)}.gif?${timestamp}`;
                }
            } else if (prefix === 'hk') {
                if (type === 'min') {
                    url = `https://image.sinajs.cn/newchart/png/${type}/${prefix}/${code.substring(2)}.png?${timestamp}`;
                } else {
                    url = `https://image.sinajs.cn/newchart/${prefix}_stock/${type}/${code.substring(2)}.gif?${timestamp}`;
                }
            }

            // é‡ç½®å›¾è¡¨å†…å®¹åŒºåŸŸ
            const content = document.getElementById('chartContent');
            content.innerHTML = '<img id="chartImage" src="" alt="è‚¡ç¥¨å›¾è¡¨" style="display: none;">';

            const img = document.getElementById('chartImage');
            if (!img) {
                showChartError('å›¾è¡¨å…ƒç´ åŠ è½½å¤±è´¥');
                return;
            }

            img.src = url;

            // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            img.onerror = function() {
                showChartError('å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯¥è‚¡ç¥¨å¯èƒ½æš‚æ— å›¾è¡¨æ•°æ®');
            };

            img.onload = function() {
                this.style.display = 'block';
            };
        }

        // æ˜¾ç¤ºå›¾è¡¨é”™è¯¯
        function showChartError(message) {
            const content = document.getElementById('chartContent');
            content.innerHTML = `
                <div class="chart-error">
                    <p>${message}</p>
                    <p style="font-size: 12px; margin-top: 10px; color: #999;">
                        æŒ‡æ•°ã€åœç‰Œè‚¡ç¥¨å¯èƒ½æ— æ³•æ˜¾ç¤ºå›¾è¡¨
                    </p>
                </div>
            `;
        }

        // å…³é—­å›¾è¡¨
        function closeChart(event) {
            if (!event || event.target === document.getElementById('chartPopup')) {
                document.getElementById('chartPopup').classList.remove('active');
                currentChartStock = null;
            }
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(event, code) {
            event.preventDefault();
            currentChartStock = code;

            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('active');
        }

        // ç¼–è¾‘ç›¸å…³åŠŸèƒ½
        let editingStockCode = null;

        // æ‰“å¼€ç¼–è¾‘å¼¹çª—
        function openEditPopup(code) {
            editingStockCode = code;
            const stock = stocks.find(s => s.code === code);

            if (!stock) return;

            document.getElementById('editCode').value = stock.code;
            document.getElementById('editName').value = stock.name;
            document.getElementById('editCost').value = stock.cost && stock.cost !== '--' ? stock.cost : '';
            document.getElementById('editBonds').value = stock.bonds && stock.bonds !== '--' ? stock.bonds : '';
            document.getElementById('editTargetPrice').value = stock.targetPrice && stock.targetPrice !== '--' ? stock.targetPrice : '';
            document.getElementById('editStopLoss').value = stock.stopLoss && stock.stopLoss !== '--' ? stock.stopLoss : '';

            document.getElementById('editPopup').querySelector('.chart-container').classList.add('edit-container');
            document.getElementById('editPopup').classList.add('active');

            // èšç„¦åˆ°æˆæœ¬ä»·è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('editCost').focus();
            }, 100);
        }

        // å…³é—­ç¼–è¾‘å¼¹çª—
        function closeEditPopup(event) {
            if (!event || event.target === document.getElementById('editPopup')) {
                document.getElementById('editPopup').classList.remove('active');
                editingStockCode = null;
            }
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEdit() {
            if (!editingStockCode) return;

            const stock = stocks.find(s => s.code === editingStockCode);
            if (!stock) return;

            const cost = document.getElementById('editCost').value.trim();
            const bonds = document.getElementById('editBonds').value.trim();
            const targetPrice = document.getElementById('editTargetPrice').value.trim();
            const stopLoss = document.getElementById('editStopLoss').value.trim();

            stock.cost = cost || '--';
            stock.bonds = bonds || '--';
            stock.targetPrice = targetPrice || '--';
            stock.stopLoss = stopLoss || '--';

            // é‡æ–°è®¡ç®—æ”¶ç›Š
            if (cost && cost !== '--' && parseFloat(cost) > 0) {
                const costValue = parseFloat(cost);
                const now = parseFloat(stock.now);
                if (!isNaN(now)) {
                    const income = (now - costValue);
                    stock.incomePercent = ((income / costValue) * 100).toFixed(2);

                    if (bonds && bonds !== '--') {
                        const bondsValue = parseFloat(bonds);
                        stock.income = (income * bondsValue).toFixed(2);
                    } else {
                        stock.income = '--';
                    }
                }
            } else {
                stock.incomePercent = '--';
                stock.income = '--';
            }

            saveStocks();
            renderStocks();
            closeEditPopup();
            showToast('ä¿å­˜æˆåŠŸï¼');
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            if (autoRefreshEnabled) {
                refreshTimer = setInterval(refreshStocks, 10000); // 10ç§’åˆ·æ–°
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            localStorage.setItem('leeks_auto_refresh', autoRefreshEnabled);
            updateAutoRefreshButton();
            startAutoRefresh();
        }

        function updateAutoRefreshButton() {
            const btn = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            btn.textContent = autoRefreshEnabled ? 'è‡ªåŠ¨åˆ·æ–°: å¼€' : 'è‡ªåŠ¨åˆ·æ–°: å…³';
            indicator.classList.toggle('paused', !autoRefreshEnabled);
        }

        // éšè”½æ¨¡å¼
        function toggleStealthMode() {
            stealthMode = !stealthMode;
            localStorage.setItem('leeks_stealth_mode', stealthMode);
            applyStealthMode();
            renderStocks();
        }

        function applyStealthMode() {
            const btn = document.getElementById('stealthModeBtn');
            const pageTitle = document.getElementById('pageTitle');

            btn.textContent = stealthMode ? 'éšè”½æ¨¡å¼: å¼€' : 'éšè”½æ¨¡å¼: å…³';
            btn.classList.toggle('active', stealthMode);
            document.body.classList.toggle('stealth-mode', stealthMode);

            // ä¼ªè£…çª—å£æ ‡é¢˜
            if (stealthMode) {
                pageTitle.textContent = 'é¡¹ç›®æ–‡æ¡£ - å·¥ä½œèµ„æ–™';
            } else {
                pageTitle.textContent = 'è‚¡ç¥¨è¡Œæƒ…æŸ¥çœ‹å™¨ - Leeks';
            }
        }

        // å¯¼å‡ºé…ç½®
        function exportStocks() {
            const data = JSON.stringify(stocks, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'leeks-stocks.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥é…ç½®
        function importStocks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            if (Array.isArray(imported)) {
                                stocks = imported;
                                saveStocks();
                                renderStocks();
                                refreshStocks();
                                alert('å¯¼å…¥æˆåŠŸï¼');
                            }
                        } catch (error) {
                            alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            const editPopup = document.getElementById('editPopup');
            const isEditPopupOpen = editPopup.classList.contains('active');

            // ESC å…³é—­å¼¹çª—
            if (e.key === 'Escape') {
                closeChart();
                if (isEditPopupOpen) {
                    closeEditPopup();
                }
            }

            // ç¼–è¾‘å¼¹çª—ä¸­æŒ‰ Enter ä¿å­˜
            if (isEditPopupOpen && e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                saveEdit();
            }

            // Ctrl+R åˆ·æ–°
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                refreshStocks();
            }

            // Ctrl+H å¿«é€Ÿåˆ‡æ¢éšè”½æ¨¡å¼ï¼ˆè€æ¿é”®ï¼‰
            if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                toggleStealthMode();
                showToast(stealthMode ? 'éšè”½æ¨¡å¼å·²å¼€å¯' : 'éšè”½æ¨¡å¼å·²å…³é—­');
            }
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }

        // åˆ—æ˜¾ç¤ºè®¾ç½®
        function openColumnSettings() {
            const content = document.getElementById('columnSettingsContent');
            content.innerHTML = columnConfig.map(col => `
                <div class="column-checkbox-item">
                    <input type="checkbox" id="col_${col.key}" ${visibleColumns.includes(col.key) ? 'checked' : ''}>
                    <label for="col_${col.key}">${col.name}</label>
                </div>
            `).join('');

            document.getElementById('columnSettingsPopup').classList.add('active');
        }

        function closeColumnSettings(event) {
            if (!event || event.target === document.getElementById('columnSettingsPopup')) {
                document.getElementById('columnSettingsPopup').classList.remove('active');
            }
        }

        function saveColumnSettings() {
            const checkboxes = document.querySelectorAll('#columnSettingsContent input[type="checkbox"]');
            visibleColumns = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    visibleColumns.push(cb.id.replace('col_', ''));
                }
            });

            // è‡³å°‘ä¿ç•™ç¼–ç å’Œåç§°åˆ—
            if (!visibleColumns.includes('code')) visibleColumns.push('code');
            if (!visibleColumns.includes('name')) visibleColumns.push('name');

            localStorage.setItem('leeks_visible_columns', JSON.stringify(visibleColumns));
            renderStocks();
            closeColumnSettings();
            showToast('è®¾ç½®å·²ä¿å­˜');
        }

        function selectAllColumns() {
            document.querySelectorAll('#columnSettingsContent input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllColumns() {
            document.querySelectorAll('#columnSettingsContent input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
    </script>
</body>
</html>
